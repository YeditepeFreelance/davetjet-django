<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bauhaus Color‑Block — Davetiye + RSVP</title>
    <style>
      :root {
        /* Tema renkleri — kolayca değiştirilebilir */
        --paper: #f7f5ef; /* kağıt */
        --ink: #111111; /* metin */
        --c1: #ff5a5f; /* mercan */
        --c2: #0057ff; /* kobalt mavi */
        --c3: #ffd166; /* hardal */
        --c4: #00c2a8; /* turkuaz */
        --line: #11111120; /* ince çizgi */
      }

      /* Sayfa altyapısı */
      body.invitation-page {
        margin: 0;
        font-family: "Segoe UI", system-ui, -apple-system, Roboto, Helvetica,
          Arial, sans-serif;
        background: var(--paper);
        color: var(--ink);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Poster stili dekoratif bloklar */
      .poster-wrap {
        position: relative;
        width: min(1100px, 92vw);
        margin: 40px auto 22px;
      }
      .decor {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }
      .shape {
        position: absolute;
        border-radius: 12px;
        filter: drop-shadow(0 12px 28px rgba(0, 0, 0, 0.16));
      }
      .shape.circle {
        border-radius: 50%;
      }
      .shape.half {
        border-radius: 999px 999px 0 0;
      }
      .shape.band {
        height: 18px;
        border-radius: 999px;
      }

      /* Yerleşim: üst sol daire, sağ yarım daire, altta blok ve bantlar */
      .s1 {
        width: 140px;
        height: 140px;
        background: var(--c1);
        left: -18px;
        top: -18px;
      }
      .s2 {
        width: 260px;
        height: 260px;
        background: var(--c2);
        right: -30px;
        top: 40px;
        border-radius: 0 0 260px 260px;
      }
      .s3 {
        width: 220px;
        height: 160px;
        background: var(--c3);
        left: -26px;
        bottom: 80px;
      }
      .s4 {
        width: 180px;
        height: 16px;
        background: var(--c4);
        left: 36px;
        bottom: 44px;
      }
      .s5 {
        width: 300px;
        height: 16px;
        background: var(--ink);
        left: 236px;
        bottom: 44px;
        opacity: 0.15;
      }

      /* Halftone/grain dokusu (ince) */
      .grain {
        position: absolute;
        inset: -20%;
        pointer-events: none;
        mix-blend-mode: multiply;
        opacity: 0.06;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="1" numOctaves="2"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
      }

      /* Davetiye kartı (Bauhaus tipografisi) */
      .invitation-card {
        position: relative;
        background: #ffffff;
        border: 1px solid var(--line);
        border-radius: 20px;
        padding: clamp(18px, 4.5vmin, 42px) clamp(18px, 4.8vmin, 54px);
        box-shadow: 0 16px 40px rgba(17, 17, 17, 0.08);
        overflow: hidden;
      }
      .brand-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 10px;
      }
      .brand {
        letter-spacing: 0.22em;
        text-transform: uppercase;
        font-weight: 800;
        font-size: 0.92rem;
      }
      .date-sm {
        font-weight: 600;
        opacity: 0.9;
      }
      .title {
        display: grid;
        grid-template-columns: auto auto auto;
        align-items: end;
        gap: 12px;
        margin: 8px 0 8px;
      }
      .title h1 {
        margin: 0;
        font-size: clamp(2rem, 6.2vmin, 4.2rem);
        line-height: 1.02;
        letter-spacing: 0.01em;
        font-weight: 900;
      }
      .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--c1);
        align-self: center;
      }
      .subtitle {
        margin-top: 6px;
        color: #3a3a3a;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
        margin: 18px 0 8px;
      }
      .pill {
        border: 1px solid var(--ink);
        border-radius: 999px;
        padding: 10px 14px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .pill .swatch {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .pill.time .swatch {
        background: var(--c2);
      }
      .pill.place .swatch {
        background: var(--c3);
      }
      .pill.dress .swatch {
        background: var(--c4);
      }

      .divider {
        height: 2px;
        background: repeating-linear-gradient(
          90deg,
          var(--ink),
          var(--ink) 8px,
          transparent 8px,
          transparent 16px
        );
        opacity: 0.2;
        margin: 16px 0 10px;
      }
      .note {
        font-size: 0.98rem;
        color: #333;
      }

      /* RSVP formu (blok estetiği) */
      .rsvp-form {
        margin-top: 18px;
        background: #ffffff;
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: clamp(16px, 3.8vmin, 26px);
        box-shadow: 0 10px 28px rgba(17, 17, 17, 0.06);
      }
      .rsvp-form h2 {
        margin: 0 0 12px;
        text-align: center;
        font-size: clamp(1.1rem, 3.4vmin, 1.6rem);
        letter-spacing: 0.04em;
      }
      .input-group {
        position: relative;
        margin-bottom: 10px;
      }
      .input-group input {
        width: 100%;
        padding: 0.9rem 0.95rem;
        border: 2px solid #11111122;
        border-radius: 12px;
        font-size: 1rem;
      }
      .input-group input:focus {
        outline: none;
        border-color: var(--c1);
        box-shadow: 0 0 0 4px #ff5a5f22;
      }
      .suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid var(--line);
        border-top: none;
        z-index: 100;
        max-height: 180px;
        overflow: auto;
        display: none;
      }
      .suggestion-item {
        padding: 0.6rem 0.8rem;
        cursor: pointer;
      }
      .suggestion-item:hover {
        background: #fafafa;
      }

      .rsvp-status {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content: center;
        margin: 8px 0 10px;
      }
      .chip {
        padding: 0.6rem 1.2rem;
        border-radius: 999px;
        border: 2px solid #11111122;
        background: #fff;
        cursor: pointer;
        user-select: none;
        font-weight: 800;
        letter-spacing: 0.02em;
      }
      .chip[data-status="yes"].active {
        background: var(--c2);
        color: #fff;
        border-color: var(--c2);
      }
      .chip[data-status="maybe"].active {
        background: var(--c3);
        color: #111;
        border-color: var(--c3);
      }
      .chip[data-status="no"].active {
        background: var(--c1);
        color: #fff;
        border-color: var(--c1);
      }

      .rsvp-submit {
        width: 100%;
        padding: 0.95rem;
        font-weight: 900;
        letter-spacing: 0.04em;
        background: #111;
        color: #fff;
        border: none;
        border-radius: 12px;
        cursor: pointer;
      }
      .rsvp-submit:disabled {
        background: #11111133;
        color: #777;
        cursor: not-allowed;
      }
      .rsvp-msg {
        margin-top: 0.7rem;
        min-height: 1.2rem;
        text-align: center;
        font-weight: 600;
      }
      .rsvp-msg.ok {
        color: #0a7a4c;
      }
      .rsvp-msg.err {
        color: #b00020;
      }

      /* Responsive */
      @media (max-width: 760px) {
        .info-grid {
          grid-template-columns: 1fr;
        }
        .poster-wrap {
          margin: 22px auto 16px;
        }
        .s1 {
          width: 100px;
          height: 100px;
          left: -12px;
          top: -12px;
        }
        .s2 {
          width: 200px;
          height: 200px;
          right: -20px;
          top: 22px;
          border-radius: 0 0 200px 200px;
        }
        .s3 {
          width: 160px;
          height: 120px;
          left: -14px;
          bottom: 68px;
        }
        .s4 {
          width: 120px;
          left: 24px;
          bottom: 34px;
        }
        .s5 {
          width: 200px;
          left: 160px;
          bottom: 34px;
        }
      }

      /* Gizli slug tutucu */
      #inv-slug {
        display: none;
      }
    </style>
  </head>
  <body class="invitation-page">
    <div class="poster-wrap">
      <div class="decor" aria-hidden="true">
        <div class="shape circle s1"></div>
        <div class="shape half s2"></div>
        <div class="shape s3"></div>
        <div class="shape band s4"></div>
        <div class="shape band s5"></div>
        <div class="grain"></div>
      </div>

      <!-- Davetiye kartı (Bauhaus estetiği) -->
      <div
        class="invitation-card"
        role="img"
        aria-label="Bauhaus color‑block davetiye"
      >
        <div class="brand-row">
          <div class="brand">INVITE</div>
          <div class="date-sm" id="event-date">12 • EYLÜL • 2025</div>
        </div>

        <div class="title">
          <h1 id="event-title">ELİF & DENİZ</h1>
          <div class="dot" aria-hidden="true"></div>
          <h1>DAVET</h1>
        </div>
        <div class="subtitle" id="event-message">
          Birlikte yeni bir başlangıcı kutlamaya davetlisiniz.
        </div>

        <div class="info-grid" aria-label="Etkinlik detayları">
          <div class="pill time">
            <span class="swatch" aria-hidden="true"></span
            ><span
              ><strong>SAAT:</strong>
              <span id="event-time" data-id="time"></span
            ></span>
          </div>
          <div class="pill place">
            <span class="swatch" aria-hidden="true"></span
            ><span
              ><strong>YER:</strong>
              <span id="event-location" data-id="location"></span
            ></span>
          </div>
          <div class="pill dress">
            <span
              class="swatch"
              aria-hidden="true"
              contenteditable="true"
            ></span
            ><span><strong>NOT:</strong> Renkli bir detay serbest</span>
          </div>
        </div>

        <div class="divider" role="separator"></div>
        <p class="note" contenteditable="true">
          Şıklığınızla bize katılın. — <em>Renkli bloklar, neşeli bir akşam</em>
        </p>
      </div>
    </div>

    <!-- RSVP Formu -->
    <div class="rsvp-form" aria-labelledby="rsvp-title">
      <h2 id="rsvp-title">Katılım Bildirimi</h2>

      <div class="input-group">
        <input
          type="text"
          id="rsvp-name"
          placeholder="Adınızı yazın"
          autocomplete="off"
          aria-autocomplete="list"
          aria-expanded="false"
          aria-controls="name-suggestions"
        />
        <div
          class="suggestions"
          id="name-suggestions"
          role="listbox"
          aria-live="polite"
        ></div>
      </div>

      <div class="rsvp-status" role="group" aria-label="Katılım durumu seçin">
        <div class="chip" data-status="yes" role="button" tabindex="0">
          Geleceğim
        </div>
        <div class="chip" data-status="maybe" role="button" tabindex="0">
          Emin Değilim
        </div>
        <div class="chip" data-status="no" role="button" tabindex="0">
          Gelmeyeceğim
        </div>
      </div>

      <button id="rsvp-submit" class="rsvp-submit" disabled>Gönder</button>
      <div id="rsvp-msg" class="rsvp-msg" aria-live="polite"></div>
    </div>

    <!-- Django view slug buraya yazabilir; yoksa URL'den türetilir -->
    <span id="inv-slug"></span>

    <script>
      // --- Utilities ---
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2)
          return decodeURIComponent(parts.pop().split(";").shift());
      }
      function debounce(fn, delay = 250) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), delay);
        };
      }
      function deriveSlugFromURL() {
        const parts = window.location.pathname.split("/").filter(Boolean);
        return parts.pop() || "";
      }

      document.addEventListener("DOMContentLoaded", () => {
        const nameInput = document.getElementById("rsvp-name");
        const suggestionsBox = document.getElementById("name-suggestions");
        const statusChips = document.querySelectorAll(".chip");
        const submitBtn = document.getElementById("rsvp-submit");
        const msg = document.getElementById("rsvp-msg");

        let slug = (
          document.getElementById("inv-slug")?.textContent || ""
        ).trim();
        if (!slug) slug = deriveSlugFromURL();

        let selectedStatus = null;
        let currentFetchController = null;
        function updateButtonState() {
          submitBtn.disabled = !nameInput.value.trim() || !selectedStatus;
        }

        // Status seçimi + klavye
        statusChips.forEach((chip) => {
          function activate() {
            statusChips.forEach((c) => c.classList.remove("active"));
            chip.classList.add("active");
            selectedStatus = chip.dataset.status;
            updateButtonState();
          }
          chip.addEventListener("click", activate);
          chip.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              activate();
            }
          });
        });

        // Dışarı tıklayınca önerileri kapat
        document.addEventListener("click", (e) => {
          if (!suggestionsBox.contains(e.target) && e.target !== nameInput) {
            suggestionsBox.style.display = "none";
            nameInput.setAttribute("aria-expanded", "false");
          }
        });

        // İsim yazıldığında öneriler (debounced)
        const fetchSuggestions = debounce(async () => {
          const q = nameInput.value.trim();
          if (q.length < 1) {
            suggestionsBox.style.display = "none";
            nameInput.setAttribute("aria-expanded", "false");
            return;
          }
          if (currentFetchController) currentFetchController.abort();
          currentFetchController = new AbortController();
          try {
            const res = await fetch(
              `/recipients/${encodeURIComponent(slug)}/?q=${encodeURIComponent(
                q
              )}`,
              { signal: currentFetchController.signal }
            );
            if (!res.ok) throw new Error("Öneriler alınamadı");
            const data = await res.json();
            suggestionsBox.innerHTML = "";
            if (Array.isArray(data) && data.length) {
              data.forEach((item, idx) => {
                const div = document.createElement("div");
                div.className = "suggestion-item";
                div.setAttribute("role", "option");
                div.id = `suggestion-${idx}`;
                div.textContent = item.name;
                div.addEventListener("click", () => {
                  nameInput.value = item.name;
                  suggestionsBox.style.display = "none";
                  nameInput.setAttribute("aria-expanded", "false");
                  updateButtonState();
                });
                suggestionsBox.appendChild(div);
              });
              suggestionsBox.style.display = "block";
              nameInput.setAttribute("aria-expanded", "true");
            } else {
              suggestionsBox.style.display = "none";
              nameInput.setAttribute("aria-expanded", "false");
            }
          } catch (err) {
            /* abort sessiz */
          }
        }, 250);

        nameInput.addEventListener("input", () => {
          updateButtonState();
          fetchSuggestions();
        });
        nameInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            if (!submitBtn.disabled) submitBtn.click();
          }
        });

        // Form gönderimi
        submitBtn.addEventListener("click", async () => {
          msg.textContent = "";
          msg.className = "rsvp-msg";
          submitBtn.disabled = true;
          const csrftoken = getCookie("csrftoken");
          try {
            const res = await fetch(
              `/recipients/${encodeURIComponent(slug)}/`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": csrftoken || "",
                },
                body: JSON.stringify({
                  name: nameInput.value.trim(),
                  status: selectedStatus,
                }),
                credentials: "same-origin",
              }
            );
            const data = await res.json().catch(() => ({}));
            if (res.ok && data && data.message) {
              msg.textContent = data.message;
              msg.className = "rsvp-msg ok";
            } else {
              msg.textContent =
                data.error || "Bir hata oluştu. Lütfen tekrar deneyin.";
              msg.className = "rsvp-msg err";
            }
          } catch (e) {
            msg.textContent = "Ağ hatası. Lütfen tekrar deneyin.";
            msg.className = "rsvp-msg err";
          } finally {
            submitBtn.disabled = false;
          }
        });
      });
    </script>
  </body>
</html>
