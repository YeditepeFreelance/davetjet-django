{% extends '../dashboard-base.html' %}
{% load static %}

{% block content %}
<div class="invitation-wizard-container">
  <!-- Progress -->
  <div class="wizard-progress" role="tablist" aria-label="Adım İlerlemesi">
    <div class="wizard-progressbar" aria-hidden="true"><span class="bar"></span></div>
    <button type="button" class="step active" data-step="1" role="tab" aria-selected="true" tabindex="0">1. Şablon</button>
    <button type="button" class="step" data-step="2" role="tab" tabindex="-1">2. Bilgiler</button>
    <button type="button" class="step" data-step="3" role="tab" tabindex="-1">3. Ayarlar</button>
    <button type="button" class="step" data-step="4" role="tab" tabindex="-1">4. Mesaj & Önizleme</button>
    <button type="button" class="step" data-step="5" role="tab" tabindex="-1">5. Paylaş</button>
  </div>

  <div class="wizard-body">
    <!-- LEFT -->
    <div class="wizard-form-area">

      <!-- Step 1: Template -->
      <div class="wizard-step step-0" data-step="1">
        <div class="step-head">
          <h2>Şablon Seçimi</h2>
          <p class="muted">Stili seçin; içerikleri sonraki adımlarda düzenleyebilirsiniz.</p>
        </div>
        <div class="template-gallery">
          <label class="template-card selected" data-template="classic">
            <input type="radio" name="template" value="classic" checked>
            <div class="thumb"><img src="{% static 'images/template1.png' %}" alt="Klasik"></div>
            <div class="meta"><p>Klasik</p><span class="badge">Önerilen</span></div>
          </label>
          <label class="template-card" data-template="modern">
            <input type="radio" name="template" value="modern">
            <div class="thumb"><img src="{% static 'images/template2.png' %}" alt="Modern"></div>
            <div class="meta"><p>Modern</p></div>
          </label>
          <label class="template-card" data-template="minimal">
            <input type="radio" name="template" value="minimal">
            <div class="thumb"><img src="{% static 'images/template3.png' %}" alt="Minimal"></div>
            <div class="meta"><p>Minimal</p></div>
          </label>
        </div>
      </div>

      <!-- Step 2: Basic Info -->
      <form id="step1-form" class="wizard-step step-1 hidden" data-step="2" novalidate>
        <div class="step-head">
          <h2>Temel Bilgiler</h2>
          <p class="muted">Başlık, tarih ve saat zorunludur. Konum ve mesaj isteğe bağlı.</p>
        </div>

        <label for="eventTitle">Davet Başlığı</label>
        <input type="text" id="eventTitle" required placeholder="Örn: Ahmet & Ayşe Düğünü" autocomplete="off">

        <div class="form-row">
          <div>
            <label for="eventDate">Tarih</label>
            <input type="date" id="eventDate" required>
          </div>
          <div>
            <label for="eventTime">Saat</label>
            <input type="time" id="eventTime" required>
          </div>
        </div>

        <label for="eventLocation">Konum</label>
        <input type="text" id="eventLocation" placeholder="Örn: Sahil Düğün Bahçesi, İstanbul">

        <label for="eventMessage">Açıklama</label>
        <textarea id="eventMessage" rows="3" placeholder="Kısa bir davet mesajı..."></textarea>
      </form>

      <!-- Step 3: Settings (Reminders / Channels / Quiet hours) -->
     <!-- Step 3: Settings (Reminders / Channels) -->
<div class="wizard-step step-2 hidden" data-step="3" id="step-settings">
  <div class="step-head">
    <h2 class="step-title">Davet Ayarları</h2>
    <p class="muted">Hatırlatıcı ve kanal ayarları.</p>
  </div>

  <div class="settings-grid">
    <!-- Reminders -->
    <section class="card soft rem-card" aria-labelledby="rem-title">
      <header class="card-head">
        <div class="head-left">
          <div class="icon-badge" aria-hidden="true"><i class="fas fa-bell"></i></div>
          <div>
            <h3 id="rem-title">Hatırlatıcılar</h3>
            <p class="muted">Etkinlikten önce otomatik bilgilendirme gönder.</p>
          </div>
        </div>
        <div class="head-right">
          <label class="switch">
            <input type="checkbox" id="remindersEnabled">
            <span class="slider"></span>
          </label>
        </div>
      </header>

      <div class="card-body" id="reminderControls">
        <!-- Kota: çoklu seçim -->
        <div class="quota" aria-live="polite">
          <div class="quota-top">
            <span class="label">Seçili hatırlatıcı</span>
            <span class="value"><strong id="remSelValue">0</strong>/<span id="remMaxValue">—</span></span>
          </div>
          <div class="quota-bar" aria-hidden="true">
            <div class="quota-fill" id="remFill" style="width:0%"></div>
          </div>
        </div>

        <!-- Gün bazlı çoklu seçim -->
        <div class="timeline days-multi">
          <div class="chips" id="presetDays">
            <label class="chip"><input type="checkbox" class="remDay" value="1"> <span>1 gün</span></label>
            <label class="chip"><input type="checkbox" class="remDay" value="3"> <span>3 gün</span></label>
            <label class="chip"><input type="checkbox" class="remDay" value="7"> <span>7 gün</span></label>
            <label class="chip"><input type="checkbox" class="remDay" value="14"> <span>14 gün</span></label>
          </div>

          <div class="custom-inline">
            <label for="remAddDay" class="muted">Özel gün</label>
            <input type="number" id="remAddDay" min="1" max="30" placeholder="1–30" inputmode="numeric" style="max-width:120px">
            <button type="button" id="remAddBtn" class="btn-ghost">Ekle</button>
          </div>

          <div class="selected-days" id="selectedDays"></div>
        </div>

        <div class="channels">
          <span class="channels-title">Kanal</span>
          <div class="channel-badges">
            <label class="badge"><input type="checkbox" class="reminderChannel" value="email" checked> <i class="fas fa-envelope"></i> E-posta</label>
            <label class="badge"><input type="checkbox" class="reminderChannel" value="sms"> <i class="fas fa-sms"></i> SMS</label>
          </div>
          <p class="muted xs">Paketinizde olmayan kanallar otomatik devre dışıdır.</p>
        </div>

        <div class="warn hidden" id="reminderWarning">
          <i class="fas fa-exclamation-triangle"></i> Lütfen 1–30 gün arası seçin. Kota dolduysa daha fazla ekleyemezsiniz.
        </div>
      </div>
    </section>
  </div>
</div>


      <!-- Step 4: Message & Multi-Channel Preview -->
      <div class="wizard-step step-3 hidden" data-step="4">
        <div class="step-head">
          <h2>Mesaj & Kanal Önizlemesi</h2>
          <p class="muted">Metni düzenledikçe SMS ve e-posta kartları canlı güncellenir.</p>
        </div>

        <label for="broadcastMessage">Gönderilecek Mesaj</label>
        <textarea id="broadcastMessage" rows="3" placeholder="Kısa bir davet mesajı yazın..."></textarea>
        <small class="muted" id="smsCounterBar"><span class="count">0</span>/<span class="limit">160</span> <span class="segments">(1 SMS)</span></small>

        <div class="message-preview">
          <div class="mp-header">
            <div class="mp-tabs" role="tablist">
              <button class="mp-tab active" data-target="#mp-sms" role="tab" aria-selected="true">SMS</button>
              <button class="mp-tab" data-target="#mp-email" role="tab">E-posta</button>
            </div>
            <div class="mp-tools">
              <button class="mp-copy" id="copyMsgBtn" title="Mesajı kopyala" aria-label="Mesajı kopyala"><i class="fas fa-copy"></i></button>
            </div>
          </div>

          <div class="mp-panels">
            <div class="mp-panel active" id="mp-sms" role="tabpanel">
              <div class="mp-device phone" aria-label="SMS Önizleme">
                <div class="statusbar"></div>
                <div class="chat-bubble from-me" id="mp-sms-text">[SMS önizleme]</div>
              </div>
              <div class="mp-hints"><small>Unicode/emojiler SMS segment sayısını artırabilir.</small></div>
            </div>

            <div class="mp-panel" id="mp-email" role="tabpanel">
              <div class="mail-card">
                <div class="mail-header">
                  <div class="avatar">DJ</div>
                  <div class="meta">
                    <strong>Gönderen:</strong> no-reply@davetjet.com<br>
                    <strong>Konu:</strong> <span id="mp-email-subject">[Konu]</span>
                  </div>
                </div>
                <div class="mail-body" id="mp-email-body">[E-posta gövdesi önizleme]</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 5: Share -->
      <div class="wizard-step step-4 hidden" data-step="5">
        <div class="step-head">
          <h2>Paylaş & Aksiyonlar</h2>
        </div>

        <div class="share-actions pretty">
          <!-- Link Card -->
          <section class="share-card glass">
            <header><i class="fas fa-link"></i> Paylaşılabilir Bağlantı</header>
            <div class="link-row">
              <input type="text" id="shareLink" readonly value="https://davetjet.com/—" aria-label="Paylaşılabilir bağlantı">
              <button class="btn-ghost" id="copyShare"><i class="fas fa-copy"></i> Kopyala</button>
            </div>
          </section>

          <!-- Quick -->
          <section class="share-card glass">
            <header><i class="fas fa-bolt"></i> Hızlı Aksiyon</header>
            <div class="quick-row">
              <button class="pill email" id="quickEmail"><i class="fas fa-envelope"></i> E-posta</button>
              <button class="pill sms" id="quickSms"><i class="fas fa-sms"></i> SMS</button>
            </div>
            
          </section>

          <!-- Final -->
          <section class="share-card glass">
            <header><i class="fas fa-flag-checkered"></i> Son</header>
            <div class="final-row">
              <button type="button" class="btn" id="saveDraftBtn">Taslağa Kaydet</button>
              <button type="button" class="btn btn--primary" id="finishBtn">Kaydet</button>
              <button id="updateBtn" type="button" class="btn btn--primary hidden">Güncelle</button>
            </div>
            <small class="muted xs">Taslak; alıcı eklenmeden kaydedilir.</small>
          </section>
        </div>
      </div>

      <!-- Nav -->
      <div class="wizard-nav">
        <button type="button" class="btn back-btn" id="prevBtn" disabled>Geri</button>
        <button type="button" class="btn next-btn" id="nextBtn">İleri</button>
        <button type="button" class="btn" id="openDraftsBtn">Taslaklar</button>
      </div>
    </div>

    <!-- RIGHT: Live Preview -->
    <aside class="wizard-preview-area" id="previewArea" data-template="classic">
      <div class="preview-header">
        <h3>Canlı Önizleme</h3>
        <button id="expandPreviewBtn" title="Tam ekran önizleme" aria-label="Tam ekran önizleme"><i class="fas fa-expand"></i></button>
      </div>
      <div class="preview-frame-wrapper">
        <iframe id="livePreview" frameborder="0" title="Davetiye Canlı Önizleme"></iframe>
      </div>
    </aside>
  </div>

  <!-- Fullscreen modal -->
  <div id="fullscreenPreviewModal" class="fullscreen-modal hidden" role="dialog" aria-modal="true" aria-labelledby="fs-title">
    <div class="modal-header">
      <h4 id="fs-title">Davetiye Önizleme</h4>
      <button id="closeFullscreenPreview" aria-label="Kapat">&times;</button>
    </div>
    <div class="modal-body">
      <iframe id="fullscreenIframe" frameborder="0" title="Davetiye Tam Ekran Önizleme"></iframe>
    </div>
  </div>

  <!-- Drafts Modal (değişmedi) -->
  <div id="draftsModal" class="fullscreen-modal hidden" role="dialog" aria-modal="true" aria-labelledby="drafts-title">
    <div class="drafts-modal-panel" role="document">
      <div class="dm-head">
        <div class="title"><i class="fas fa-file-alt"></i> Taslaklar</div>
        <button type="button" class="dm-close" id="closeDraftsModal" aria-label="Kapat"><i class="fas fa-times"></i></button>
      </div>
      <div class="dm-body">
        <div id="draftsEmpty" class="dm-empty hidden">
          <div class="bubble"><i class="fas fa-inbox"></i></div>
          <div class="text"><strong>Henüz taslak yok</strong><span class="muted">Davet oluşturduğunda burada görünecek.</span></div>
        </div>
        <div id="draftsSkeleton" class="drafts-grid skeleton">
          <div class="draft-card sk"></div><div class="draft-card sk"></div><div class="draft-card sk"></div>
        </div>
        <div id="draftsGrid" class="drafts-grid"></div>
      </div>
      <div class="dm-foot">
        <button type="button" class="btn btn--ghost" id="newDraftBtn"><i class="fas fa-plus"></i> Yeni taslak</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{% if inv_json %}<script>window.INV_META = {{ inv_json|safe }};</script>{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ====== Elements
  let currentStep = 0;
  const steps = document.querySelectorAll(".wizard-step");
  const progressSteps = document.querySelectorAll(".wizard-progress .step");
  const progressBar = document.querySelector(".wizard-progressbar .bar");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const finishBtn = document.getElementById("finishBtn");
  const saveDraftBtn = document.getElementById("saveDraftBtn");
  const updateBtn = document.getElementById("updateBtn");

  const previewIframe = document.getElementById("livePreview");
  const fullscreenIframe = document.getElementById("fullscreenIframe");

  // Form fields
  const eventTitle = document.getElementById("eventTitle");
  const eventDate = document.getElementById("eventDate");
  const eventTime = document.getElementById("eventTime");
  const eventLocation = document.getElementById("eventLocation");
  const eventMessage = document.getElementById("eventMessage");

  // Reminders / channels (MULTI) — quiet hours kaldırıldı
  const remEnabledEl = document.getElementById("remindersEnabled");
  const remCtrEl     = document.getElementById("reminderControls");
  const quotaSelVal  = document.getElementById("remSelValue");
  const quotaMaxVal  = document.getElementById("remMaxValue");
  const quotaFillEl  = document.getElementById("remFill");
  const warnEl       = document.getElementById("reminderWarning");
  const presetDayEls = Array.from(document.querySelectorAll(".remDay"));
  const remAddDay    = document.getElementById("remAddDay");
  const remAddBtn    = document.getElementById("remAddBtn");
  const selectedDaysWrap = document.getElementById("selectedDays");
  const channelEls   = Array.from(document.querySelectorAll(".reminderChannel"));

  // Message preview
  const broadcastMessage = document.getElementById("broadcastMessage");
  const smsBar = document.getElementById("smsCounterBar");
  const smsCountEl = smsBar?.querySelector(".count");
  const smsSegsEl = smsBar?.querySelector(".segments");
  const smsLimitEl = smsBar?.querySelector(".limit");

  // Share
  const shareLink = document.getElementById("shareLink");
  const copyShare = document.getElementById("copyShare");
  const quickEmail = document.getElementById("quickEmail");
  const quickSms = document.getElementById("quickSms");

  // Drafts modal
  const draftsModal = document.getElementById("draftsModal");
  const openDraftsBtn = document.getElementById("openDraftsBtn");
  const closeDraftsModal = document.getElementById("closeDraftsModal");
  const draftsGrid = document.getElementById("draftsGrid");

  // --- EDIT ID BOOT ---
  const params   = new URLSearchParams(location.search);
  const bootMeta = window.INV_META || null;
  let editId = params.get("inv")
             || (bootMeta && bootMeta.id ? String(bootMeta.id) : document.body.dataset.invId || null);
  window.editId = editId;
  const forcedDraft = params.get("draft") === "1" || (bootMeta ? bootMeta.is_draft : false);
  let isEditing = !!editId;
  let isEditingDraft = forcedDraft || !!bootMeta?.is_draft;

  // ===== Helpers
  const getCSRF = () => document.cookie.match(/csrftoken=([^;]+)/)?.[1] ?? "";

  function toast(msg){
    let t = document.querySelector('.mini-toast');
    if(!t){ t = document.createElement('div'); t.className = 'mini-toast'; document.body.appendChild(t); }
    t.textContent = msg;
    requestAnimationFrame(()=>{ t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), 1800); });
  }

  const setProgress = (index) => {
    const pct = ((index) / (steps.length - 1)) * 100;
    progressBar && (progressBar.style.width = pct + "%");
    progressSteps.forEach((p, i) => {
      p.classList.toggle("active", i === index);
      p.setAttribute("aria-selected", i === index ? "true" : "false");
      p.tabIndex = i === index ? 0 : -1;
    });
  };

  // ===== Reminders STATE (çoklu seçim + kota)
  const rem = {
    enabled: false,
    presetDays: new Set(),   // {1,3,7,14}
    customDays: new Set(),   // {n}
    channels: { email: true, sms: false },
    quota: { max: 0, used: 0 },   // max user’dan
  };

  // — Kota: User modelinden çek (endpoint yoksa INV_META -> fallback)
  async function fetchReminderQuota() {
    // 1) INV_META’dan dene
    if (window.INV_META && typeof window.INV_META.max_reminders === "number") {
      rem.quota.max = window.INV_META.max_reminders;
    }
    // 2) API dene (varsa)
    try {
      const r = await fetch("/invitations/api/reminders-quota/", { headers: {"X-Requested-With":"XMLHttpRequest"} });
      if (r.ok) {
        const data = await r.json();
        if (typeof data.max === "number") rem.quota.max = data.max;
      }
    } catch(_) {}

    // 3) fallback
    if (!rem.quota.max || rem.quota.max < 1) rem.quota.max = 3;

    if (quotaMaxVal) quotaMaxVal.textContent = String(rem.quota.max);
    updateQuotaUI();
  }

  function totalSelected() {
    return new Set([...rem.presetDays, ...rem.customDays]).size;
  }
  function buildReminderConfig(){
    // seçili günleri (1..30) dakikaya çevir
    let days = [...new Set([...rem.presetDays, ...rem.customDays])].sort((a,b)=>a-b);
    // kota aşmamak için ilk N gün
    days = days.slice(0, Math.max(0, rem.quota.max));
    return rem.enabled ? days.map(d => d * 1440) : [];
  }
  function getDeliverySettings(){
    return {
      email: !!rem.channels.email,
      sms: !!rem.channels.sms,
    };
  }
  function applyRemindersUIEnabled(on){
    if (!remCtrEl) return;
    remCtrEl.classList.toggle("is-off", !on);
    remCtrEl.querySelectorAll("input,select,button").forEach(el=>{
      if (el.id === "remindersEnabled") return;
      el.disabled = !on;
    });
  }
  function updateQuotaUI(){
    const used = totalSelected();
    rem.quota.used = used;
    if (quotaSelVal) quotaSelVal.textContent = String(used);
    if (quotaMaxVal && quotaFillEl) {
      const max = Math.max(1, rem.quota.max || 1);
      quotaFillEl.style.width = `${Math.min(100, (used / max) * 100)}%`;
    }
    if (warnEl) warnEl.classList.toggle("hidden", !(rem.enabled && (used === 0 || used > rem.quota.max)));
  }
  function validateReminders(){
    if (!rem.enabled) return true;
    const used = totalSelected();
    if (used === 0) { toast("En az bir hatırlatıcı günü seçin."); return false; }
    if (used > rem.quota.max) { toast("Hatırlatıcı kotası doldu."); return false; }
    return true;
  }
  function renderSelectedDays(){
    if (!selectedDaysWrap) return;
    selectedDaysWrap.innerHTML = "";
    const days = [...new Set([...rem.presetDays, ...rem.customDays])].sort((a,b)=>a-b);
    days.forEach(d => {
      const chip = document.createElement("span");
      chip.className = "chip selected";
      chip.innerHTML = `${d} gün <button type="button" class="x" aria-label="Kaldır">×</button>`;
      chip.querySelector("button.x").addEventListener("click", () => {
        rem.presetDays.delete(d); rem.customDays.delete(d);
        const cb = document.querySelector(`.remDay[value="${d}"]`);
        if (cb) cb.checked = false;
        renderSelectedDays(); updateQuotaUI();
      });
      selectedDaysWrap.appendChild(chip);
    });
  }
  function hydrateRemindersFromData(meta){
    rem.enabled = !!meta?.reminders;
    if (remEnabledEl) remEnabledEl.checked = rem.enabled;

    // kota
    if (typeof meta?.max_reminders === "number" && meta.max_reminders > 0) {
      rem.quota.max = meta.max_reminders;
      if (quotaMaxVal) quotaMaxVal.textContent = String(rem.quota.max);
    }

    // dakika -> gün
    const cfg = Array.isArray(meta?.reminder_config) ? meta.reminder_config : [];
    const days = cfg.map(m => Math.round((m || 0) / 1440)).filter(d => d >= 1 && d <= 30);
    days.forEach(d => {
      const cb = document.querySelector(`.remDay[value="${d}"]`);
      if (cb) { cb.checked = true; rem.presetDays.add(d); }
      else { rem.customDays.add(d); }
    });

    // kanallar
    const ds = meta?.delivery_settings || {};
    rem.channels.email = ds.email !== false;
    rem.channels.sms   = !!ds.sms;
    channelEls.forEach(cb=>{
      if (cb.value in rem.channels) cb.checked = !!rem.channels[cb.value];
    });

    applyRemindersUIEnabled(rem.enabled);
    renderSelectedDays(); updateQuotaUI();
  }

  // ===== Template load + bindings
  const loadTemplate = (name) => {
    fetch(`/static/inv-temps/${name}.html`)
      .then(r => r.text())
      .then(html => {
        const onLoad = () => {
          pushFormIntoIframe(previewIframe);
          enableIframeSync(previewIframe, null);
          previewIframe.removeEventListener('load', onLoad);
        };
        previewIframe.addEventListener('load', onLoad);
        previewIframe.srcdoc = html;
      });
  };

  document.querySelectorAll(".template-card").forEach(card => {
    card.addEventListener("click", () => {
      document.querySelectorAll(".template-card").forEach(c => c.classList.remove("selected"));
      card.classList.add("selected");
      loadTemplate(card.dataset.template);
    });
    card.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); card.click(); } });
  });
  loadTemplate("classic");

  // ===== Progress / Nav
  document.querySelectorAll('.wizard-progress .step').forEach((btn, i) => {
    btn.addEventListener('click', () => {
      if (currentStep === 1 && i > 1 && !validateBasic()) return;
      showStep(i);
    });
  });

  const showStep = (index) => {
    steps.forEach((s, i) => s.classList.toggle("hidden", i !== index));
    setProgress(index);
    prevBtn.disabled = index === 0;
    nextBtn.classList.toggle("hidden", index === steps.length - 1);
    currentStep = index;
  };

  const validateBasic = () => {
    if (currentStep !== 1) return true;
    const dateStr = eventDate.value;
    const timeStr = eventTime.value;
    if (!eventTitle.value.trim() || !dateStr || !timeStr) { toast("Lütfen başlık, tarih ve saati doldurun."); return false; }
    const now = new Date();
    const dt = new Date(`${dateStr}T${timeStr}:00`);
    const threeMonths = new Date(); threeMonths.setMonth(now.getMonth() + 3);
    if (isNaN(dt)) { toast("Geçerli bir tarih/saat giriniz."); return false; }
    if (dt < now) { toast("Geçmiş bir tarih/saat olamaz."); return false; }
    if (dt > threeMonths) { toast("Tarih 3 aydan fazla ileri olamaz."); return false; }
    return true;
  };

  prevBtn.addEventListener("click", () => currentStep > 0 && showStep(currentStep - 1));
  nextBtn.addEventListener("click", () => {
    if (currentStep === 1 && !validateBasic()) return;
    showStep(Math.min(currentStep + 1, steps.length - 1));
  });

  document.addEventListener('keydown', (e)=>{ if(e.ctrlKey && e.key === 'ArrowRight') nextBtn.click(); if(e.ctrlKey && e.key === 'ArrowLeft') prevBtn.click(); });

  // ===== Form -> iframe + Multi-channel
  [eventTitle, eventDate, eventTime, eventLocation, eventMessage].forEach(inp => {
    inp && inp.addEventListener("input", () => { pushFormIntoIframe(previewIframe); refreshMultiChannel(); });
  });
  broadcastMessage?.addEventListener("input", () => { refreshMultiChannel(); });

  function pushFormIntoIframe(iframe) {
    const doc = iframe.contentDocument; if (!doc) return;
    const map = {
      "event-title": eventTitle?.value || "Etkinlik Başlığı",
      "event-date": eventDate?.value || "",
      "event-time": eventTime?.value || "",
      "event-location": eventLocation?.value || "",
      "event-message": eventMessage?.value || ""
    };
    Object.entries(map).forEach(([id, val]) => { const el = doc.getElementById(id); if (el) el.textContent = val; });
  }

  function enableIframeSync(sourceIframe, mirrorIframe) {
    const doc = sourceIframe.contentDocument; if (!doc) return;
    const pairs = {
      "event-title": eventTitle,
      "event-date": eventDate,
      "event-time": eventTime,
      "event-location": eventLocation,
      "event-message": eventMessage
    };
    Object.entries(pairs).forEach(([id, input]) => {
      const el = doc.getElementById(id);
      if (el && el.isContentEditable) {
        el.addEventListener("input", () => {
          input.value = el.textContent.trim();
          if (mirrorIframe && mirrorIframe.contentDocument) {
            const other = mirrorIframe.contentDocument.getElementById(id);
            if (other) other.textContent = el.textContent.trim();
          }
          refreshMultiChannel();
        });
      }
    });
  }

  function refreshMultiChannel() {
    const title = eventTitle?.value || "Etkinlik";
    const date = eventDate?.value || "";
    const time = eventTime?.value || "";
    const loc  = eventLocation?.value || "";
    const baseMsg = eventMessage?.value || "";
    const extra = broadcastMessage?.value || "";
    const compiled = `${title}\n${date} ${time}\n${loc}\n${extra || baseMsg}`.trim();

    const smsNode = document.getElementById("mp-sms-text");
    if (smsNode) smsNode.replaceChildren(document.createTextNode(compiled));
    updateSmsCounter(compiled);

    const subjEl = document.getElementById("mp-email-subject");
    const bodyEl = document.getElementById("mp-email-body");
    subjEl && subjEl.replaceChildren(document.createTextNode(`${title} - Davet`));
    bodyEl && bodyEl.replaceChildren(document.createTextNode(`${extra || baseMsg}\n\nTarih: ${date} ${time}\nYer: ${loc}`));
  }

  function updateSmsCounter(text) {
    if (!smsCountEl || !smsLimitEl || !smsSegsEl) return;
    const isUnicode = /[^\u0000-\u007F]/.test(text);
    const perSeg = isUnicode ? 70 : 160;
    const len = text.length;
    const segs = Math.max(1, Math.ceil(len / perSeg));
    smsCountEl.textContent = len;
    smsLimitEl.textContent = perSeg;
    smsSegsEl.textContent = `(${segs} SMS)`;
  }

  (function setupTabs(){
    const tabs = document.querySelectorAll(".mp-tab");
    const panels = document.querySelectorAll(".mp-panel");
    function setActive(btn) {
      tabs.forEach(t=>t.classList.remove("active"));
      panels.forEach(p=>p.classList.remove("active"));
      btn.classList.add("active");
      const t = document.querySelector(btn.dataset.target); t && t.classList.add("active");
    }
    tabs.forEach(btn => btn.addEventListener("click", ()=> setActive(btn)));
  })();

  document.getElementById("copyMsgBtn")?.addEventListener("click", ()=> {
    const val = document.getElementById("mp-sms-text").textContent || "";
    navigator.clipboard.writeText(val).then(()=> toast("Mesaj kopyalandı!"));
  });

  copyShare?.addEventListener("click", () => { navigator.clipboard.writeText(shareLink.value).then(()=> toast("Bağlantı kopyalandı")); });

  // Quick actions
  quickEmail?.addEventListener("click", () => {
    const link = shareLink.value || "";
    const subj = encodeURIComponent((eventTitle?.value || "Davet") + " - DavetJet");
    const body = encodeURIComponent(`${eventMessage?.value || ""}\n\n${link}`);
    window.location.href = `mailto:?subject=${subj}&body=${body}`;
  });
  quickSms?.addEventListener("click", async () => {
    const link = shareLink.value || "";
    const text = `${(eventTitle?.value || "Davet")}\n${eventDate?.value || ""} ${eventTime?.value || ""}\n${eventLocation?.value || ""}\n${eventMessage?.value || ""}\n${link}`;
    if (navigator.share) {
      try { await navigator.share({ text }); } catch(e){}
    } else {
      window.location.href = `sms:?&body=${encodeURIComponent(text)}`;
    }
  });

  // ===== Fullscreen Preview
  const expandBtn = document.getElementById("expandPreviewBtn");
  const expandModal = document.getElementById("fullscreenPreviewModal");
  const closeFullscreenBtn = document.getElementById("closeFullscreenPreview");

  expandBtn?.addEventListener("click", () => {
    const html = previewIframe.contentDocument?.documentElement?.outerHTML || "";
    const onFsLoad = () => {
      pushFormIntoIframe(fullscreenIframe);
      enableIframeSync(fullscreenIframe, previewIframe);
      fullscreenIframe.removeEventListener('load', onFsLoad);
    };
    fullscreenIframe.addEventListener('load', onFsLoad);
    fullscreenIframe.srcdoc = html;
    expandModal.classList.remove("hidden");
  });
  closeFullscreenBtn?.addEventListener("click", () => expandModal.classList.add("hidden"));

  // ===== UPDATE (publish sonrası düzenleme)
  document.addEventListener("click", async (evt) => {
    const btn = evt.target.closest("#updateBtn");
    if (!btn) return;
    evt.preventDefault(); evt.stopPropagation();

    if (!window.editId) { toast("Kayıt yüklenmedi."); return; }
    const old = btn.textContent; btn.disabled = true; btn.textContent = "Güncelleniyor…";
    try{
      if (!validateReminders()) return;

      const tplSel = document.querySelector(".template-card.selected");
      const payload = {
        name: (eventTitle?.value || "").trim(),
        message: eventMessage?.value || "",
        invitation_date: (eventDate?.value && eventTime?.value) ? `${eventDate.value}T${eventTime.value}:00` : null,
        template: tplSel ? tplSel.dataset.template : undefined,
        // Güvenlik: otomatik
        is_password_protected: true,
        password: "",
        // reminders
        reminders: rem.enabled,
        reminder_config: buildReminderConfig(),
        reminder_message: (broadcastMessage?.value || eventMessage?.value || "").trim(),
        // delivery
        delivery_settings: getDeliverySettings(),
      };

      const url = `{% url 'invitations:invitation-detail' 0 %}`.replace("0", String(window.editId));
      const r = await fetch(url, {
        method: "PATCH",
        headers: { "Content-Type":"application/json", "X-CSRFToken": getCSRF() },
        body: JSON.stringify(payload)
      });
      const isNoContent = r.status === 204 || r.headers.get("content-length") === "0";
      const data = isNoContent ? {} : await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.detail || `HTTP ${r.status}`);
      toast("Güncellendi ✅");
    }catch(e){
      console.error(e); toast("Güncellenemedi");
    }finally{
      btn.disabled = false; btn.textContent = old;
    }
  });

  // ===== DRAFTS MODAL
  const openDrafts = async () => {
    document.body.classList.add("modal-open");
    draftsModal.classList.remove("hidden");
    document.getElementById("draftsSkeleton")?.classList.remove("hidden");
    document.getElementById("draftsEmpty")?.classList.add("hidden");
    await loadDrafts();
  };
  function closeDrafts(){ draftsModal.classList.add("hidden"); document.body.classList.remove("modal-open"); }
  openDraftsBtn?.addEventListener("click", openDrafts);
  closeDraftsModal?.addEventListener("click", closeDrafts);
  draftsModal?.addEventListener("click", (e)=>{ if(e.target === draftsModal) closeDrafts(); });
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && !draftsModal?.classList.contains("hidden")) closeDrafts(); });

  async function loadInvitationById(id){
    const r = await fetch(`/invitations/api/invitations/${id}/`, { headers:{ "X-Requested-With":"XMLHttpRequest" }});
    if(!r.ok) throw new Error("Load failed");
    const data = await r.json();
    hydrateFromData(data);
  }

  async function loadDrafts(){
    const sk = document.getElementById("draftsSkeleton");
    const empty = document.getElementById("draftsEmpty");
    const grid = document.getElementById("draftsGrid");
    sk && sk.classList.remove("hidden"); empty && empty.classList.add("hidden"); grid && (grid.innerHTML = "");
    try{
      const r = await fetch("{% url 'invitations:invitation-drafts' %}", { headers: { "X-Requested-With":"XMLHttpRequest" } });
      const list = await r.json();
      sk && sk.classList.add("hidden");
      if(!Array.isArray(list) || list.length === 0){ empty && empty.classList.remove("hidden"); grid.innerHTML = ""; return; }
      grid.innerHTML = "";
      list.forEach(item => {
        const el = document.createElement("div");
        el.className = "draft-card";
        const title = item.name || "Adsız Taslak";
        const date = item.invitation_date ? new Date(item.invitation_date) : null;
        const dateStr = date ? `${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : "—";
        const avatar = (title?.trim()?.charAt(0) || "D").toUpperCase();
        el.innerHTML = `
          <div class="dc-thumb">${avatar}</div>
          <div class="dc-body">
            <div class="dc-title"><span>${title}</span><span class="chip">Taslak</span></div>
            <div class="dc-meta"><div class="row"><i class="far fa-calendar"></i> ${dateStr}</div><div class="row"><span class="dot"></span> Şablon: ${item.template || "classic"}</div></div>
          </div>
          <div class="dc-foot">
            <div class="left">ID #${item.id}</div>
            <div class="actions">
              <button type="button" class="btn" data-act="open" data-id="${item.id}"><i class="fas fa-external-link-alt"></i> Aç</button>
              <button type="button" class="btn btn--primary" data-act="promote" data-id="${item.id}"><i class="fas fa-upload"></i> Yayınla</button>
              <button type="button" class="btn btn--danger" data-act="delete" data-id="${item.id}"><i class="fas fa-trash"></i> Sil</button>
            </div>
          </div>`;
        grid.appendChild(el);
      });
      grid.querySelectorAll(".dc-foot .actions .btn").forEach(btn=>{
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          if(act === "open"){ window.location.href = "{% url 'core:edit-invitation-api' 0 %}".replace("0", id); }
          if(act === "promote"){
            const old = btn.textContent; btn.disabled = true; btn.textContent = "Yayınlanıyor…";
            try{
              const r = await fetch(`{% url 'invitations:invitation-draft-promote' 0 %}`.replace("0", id), { method:"POST", headers: { "X-CSRFToken": getCSRF() } });
              const data = (r.status === 204) ? {} : await r.json().catch(()=> ({}));
              if (!r.ok) throw new Error(data?.detail || "Promote failed");
              if (data?.share_url && shareLink) shareLink.value = data.share_url;
              showStep(4); toast("Taslak yayınlandı ✅"); btn.closest(".draft-card")?.remove();
            }catch(e){ console.error(e); toast("Yayınlama başarısız."); }
            finally{ btn.disabled = false; btn.textContent = old; }
          }
          if(act === "delete"){
            if(!confirm("Taslağı silmek istediğine emin misin?")) return;
            try{
              const r = await fetch(`{% url 'invitations:invitation-draft-delete' 0 %}`.replace("0", id), { method:"DELETE", headers:{ "X-CSRFToken": getCSRF() } });
              if(r.status === 204){ btn.closest(".draft-card")?.remove(); toast("Taslak silindi"); } else { toast("Silinemedi"); }
            }catch(e){ console.error(e); toast("Silme başarısız"); }
          }
        });
      });
    }catch(e){
      console.error(e);
      document.getElementById("draftsSkeleton")?.classList.add("hidden");
      draftsGrid.innerHTML = `<div class="muted">Taslaklar yüklenemedi.</div>`;
    }
  }

  // ===== SAVE DRAFT
  saveDraftBtn?.addEventListener("click", async () => {
    const old = saveDraftBtn.textContent;
    saveDraftBtn.disabled = true; saveDraftBtn.textContent = "Kaydediliyor…";
    try{
      const payload = {
        name: eventTitle?.value || "Yeni Davetiye",
        message: eventMessage?.value || "",
        invitation_date: (eventDate?.value && eventTime?.value) ? `${eventDate.value}T${eventTime.value}:00` : null,
        template: document.querySelector(".template-card.selected")?.dataset.template || "classic",
        is_draft: true,
        // güvenlik otomatik
        is_password_protected: true,
        password: "",
        reminders: rem.enabled,
        reminder_config: buildReminderConfig(),
        reminder_message: (broadcastMessage?.value || eventMessage?.value || "").trim(),
        delivery_settings: getDeliverySettings(),
      };

      let r;
      if (editId) {
        r = await fetch(`{% url 'invitations:invitation-detail' 0 %}`.replace("0", editId), {
          method: "PATCH",
          headers: { "Content-Type":"application/json", "X-CSRFToken": getCSRF() },
          body: JSON.stringify(payload)
        });
      } else {
        r = await fetch("{% url 'core:create-invitation-api' %}", {
          method: "POST",
          headers: { "Content-Type":"application/json", "X-CSRFToken": getCSRF() },
          body: JSON.stringify(payload)
        });
      }

      const data = (r.status === 204) ? {} : await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(data?.detail || `HTTP ${r.status}`);

      if (!editId && data?.id) {
        editId = String(data.id);
        const qs = new URLSearchParams({ inv: editId, draft: "1" });
        history.replaceState(null, "", `${location.pathname}?${qs.toString()}`);
      }
      if (data?.share_url || data?.url || data?.public_url || data?.link) {
        shareLink.value = data.share_url || data.url || data.public_url || data.link;
      }
      window.location.replace("{% url 'core:edit-recipients' 0 %}".replace("0", editId));
      toast(editId ? "Taslak güncellendi ✅" : "Taslak kaydedildi ✅");
    } catch (err) {
      console.error("[draft save] error:", err);
      toast("Taslak kaydedilemedi.");
    } finally {
      saveDraftBtn.disabled = false; saveDraftBtn.textContent = old;
    }
  });

  // ===== SINGLE INVITE LIMIT (frontend guard)
  async function canCreateAnotherInvitation(){
    try {
      // Basit kontrol: yayınlanmış davet sayısı
      const r = await fetch("/invitations/api/invitations/?is_draft=false&limit=2", { headers:{ "X-Requested-With":"XMLHttpRequest" }});
      if (!r.ok) return true; // sunucu kapalıysa engelleme
      const list = await r.json();
      const count = Array.isArray(list) ? list.length : (list?.count ?? 0);
      return count < 1; // max 1
    } catch { return true; }
  }

  // ===== PUBLISH (Yayınla)
  finishBtn?.addEventListener("click", async (e) => {
    e.preventDefault();

    if (!eventTitle.value.trim() || !eventDate.value || !eventTime.value) {
      toast("Yayınlamak için başlık, tarih ve saat gerekli."); showStep(1); return;
    }
    if (!validateReminders()) return;

    // Limit: tüm planlar max 1 yayınlanmış davetiye
    if (!(isEditing && !isEditingDraft)) { // yeni yayın veya taslağı yayınla
      const ok = await canCreateAnotherInvitation();
      if (!ok) { toast("Bu planda en fazla 1 yayınlanmış davetiye oluşturabilirsiniz."); return; }
    }

    const basePayload = {
      name: eventTitle.value.trim(),
      message: eventMessage.value || "",
      invitation_date: `${eventDate.value}T${eventTime.value}:00`,
      template: document.querySelector(".template-card.selected")?.dataset.template || "classic",
      // Güvenlik: otomatik şifreli + secure link şifresiz giriş
      is_password_protected: true,
      password: "",
      reminders: rem.enabled,
      reminder_config: buildReminderConfig(),
      reminder_message: (broadcastMessage?.value || eventMessage?.value || "").trim(),
      delivery_settings: getDeliverySettings(),
    };

    const old = finishBtn.textContent;
    finishBtn.disabled = true; finishBtn.textContent = "Yayınlanıyor…";

    try {
      if (isEditing && isEditingDraft && editId) {
        // PATCH -> PROMOTE
        const patchUrl = `{% url 'invitations:invitation-detail' 0 %}`.replace("0", editId);
        const patchRes = await fetch(patchUrl, {
          method: "PATCH",
          headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRF() },
          body: JSON.stringify({ ...basePayload, is_draft: true })
        });
        if (!patchRes.ok) throw new Error(await patchRes.text().catch(()=> "PATCH failed"));

        const promoteUrl = `{% url 'invitations:invitation-draft-promote' 0 %}`.replace("0", editId);
        const promoteRes = await fetch(promoteUrl, { method: "POST", headers: { "X-CSRFToken": getCSRF() } });
        const promoteData = (promoteRes.status === 204) ? {} : await promoteRes.json().catch(()=> ({}));
        if (!promoteRes.ok) throw new Error(promoteData?.detail || "Promote failed");

        isEditingDraft = false;
        if (promoteData?.share_url) shareLink.value = promoteData.share_url;

      } else {
        // Yeni oluştur ve yayınla
        const createRes = await fetch("{% url 'core:create-invitation-api' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRF() },
          body: JSON.stringify({ ...basePayload, is_draft: false })
        });
        const createData = await createRes.json().catch(()=> ({}));
        if (!createRes.ok) throw new Error(createData?.detail || `HTTP ${createRes.status}`);
        if (createData?.id) { editId = String(createData.id); isEditing = true; isEditingDraft = false; }
        if (createData?.share_url || createData?.url || createData?.public_url || createData?.link) {
          shareLink.value = createData.share_url || createData.url || createData.public_url || createData.link;
        }
      }

      // Yayınlandı: Update butonunu göster
      saveDraftBtn?.classList.add("hidden");
      finishBtn?.classList.add("hidden");
      updateBtn?.classList.remove("hidden");

      showStep(4);
      toast("Davet yayınlandı ✅");
    } catch (err) {
      console.error("Publish error:", err);
      toast("Yayınlanamadı. Lütfen tekrar deneyin.");
    } finally {
      finishBtn.disabled = false; finishBtn.textContent = old;
    }
  });

  // ===== Hydrate helper
  function hydrateFromData(data){
    eventTitle.value = data.name || "";
    eventMessage.value = data.message || "";
    if (data.invitation_date){
      const d = new Date(data.invitation_date);
      eventDate.value = d.toISOString().slice(0,10);
      eventTime.value = d.toTimeString().slice(0,5);
    }
    if (typeof data.location === "string") eventLocation.value = data.location;

    const tpl = data.template || "classic";
    document.querySelectorAll(".template-card").forEach(c=>c.classList.remove("selected"));
    document.querySelector(`.template-card[data-template="${tpl}"]`)?.classList.add("selected");
    loadTemplate(tpl);

    // Reminders hydrate (yeni çoklu sistem)
    hydrateRemindersFromData(data);

    // UI modu
    if (data.is_draft){
      saveDraftBtn?.classList.remove("hidden");
      finishBtn?.classList.remove("hidden");
      updateBtn?.classList.add("hidden");
    } else {
      saveDraftBtn?.classList.add("hidden");
      finishBtn?.classList.add("hidden");
      updateBtn?.classList.remove("hidden");
    }

    isEditing = true;
    isEditingDraft = !!data.is_draft;
    editId = String(data.id);

    refreshMultiChannel();
  }

  // ===== Init
  shareLink && (shareLink.value = "https://davetjet.com/davet/preview-" + Math.floor(Math.random()*99999));
  showStep(0);
  refreshMultiChannel();

  // Reminders bindings
  remEnabledEl?.addEventListener("change", (e)=>{ rem.enabled = !!e.target.checked; applyRemindersUIEnabled(rem.enabled); updateQuotaUI(); });
  presetDayEls.forEach(cb => cb.addEventListener("change", (e)=>{
    const v = parseInt(e.target.value, 10);
    if (e.target.checked) {
      const will = totalSelected() + (rem.presetDays.has(v) ? 0 : 1);
      if (will > rem.quota.max) { e.target.checked = false; toast("Kota dolu"); return; }
      rem.presetDays.add(v);
    } else {
      rem.presetDays.delete(v);
    }
    renderSelectedDays(); updateQuotaUI();
  }));
  remAddBtn?.addEventListener("click", ()=>{
    const v = parseInt(remAddDay.value, 10);
    if (Number.isNaN(v) || v < 1 || v > 30) { toast("1–30 gün arası girin"); return; }
    if (!rem.customDays.has(v) && !rem.presetDays.has(v) && totalSelected() >= rem.quota.max) {
      toast("Kota dolu"); return;
    }
    rem.customDays.add(v);
    remAddDay.value = "";
    renderSelectedDays(); updateQuotaUI();
  });
  channelEls.forEach(cb=> cb.addEventListener("change", (e)=>{ rem.channels[e.target.value] = !!e.target.checked; }));

  // Kota bilgisi getir
  fetchReminderQuota();

  // INV_META’dan hydrate (varsa) — fetchReminderQuota’dan bağımsız
  if (bootMeta) { hydrateFromData(bootMeta); }
  else if (editId) { loadInvitationById(editId).catch(err => { console.error(err); toast("Kayıt yüklenemedi"); }); }
});
</script>

{% endblock %}
