{% extends '../dashboard-base.html' %}
{% load static %}

{# ------------------------------------------------------
   INVITATION WIZARD — REV A (Minimal Glass, Refined)
   Notes:
   - Class names match HTML exactly.
   - Structure kept familiar; visuals refined; micro-interactions added.
   - Progress: adds a slim progress bar + active step accent.
   - Preview: keeps 9:16 frame, adds subtle border glow on hover.
   - Accessibility: better focus states, larger hit targets, ARIA roles.
   - JS: tiny additions (progress %, keyboard nav, smooth step changes).
   ------------------------------------------------------ #}

{% block content %}
<div class="invitation-wizard-container">
  <!-- Progress -->
  <div class="wizard-progress" role="tablist" aria-label="Adım İlerlemesi">
    <div class="wizard-progressbar" aria-hidden="true"><span class="bar"></span></div>
    <button type="button" class="step active" data-step="1" role="tab" aria-selected="true" tabindex="0">1. Şablon</button>
    <button type="button" class="step" data-step="2" role="tab" tabindex="-1">2. Bilgiler</button>
    <button type="button" class="step" data-step="3" role="tab" tabindex="-1">3. Ayarlar</button>
    <button type="button" class="step" data-step="4" role="tab" tabindex="-1">4. Mesaj & Önizleme</button>
    <button type="button" class="step" data-step="5" role="tab" tabindex="-1">5. Paylaş</button>
  </div>

  <div class="wizard-body">
    <!-- LEFT -->
    <div class="wizard-form-area">

      <!-- Step 1: Template -->
      <div class="wizard-step step-0" data-step="1">
        <div class="step-head">
          <h2>Şablon Seçimi</h2>
          <p class="muted">Stili seçin; içerikleri sonraki adımlarda düzenleyebilirsiniz.</p>
        </div>
        <div class="template-gallery">
          <label class="template-card selected" data-template="classic">
            <input type="radio" name="template" value="classic" checked>
            <div class="thumb"><img src="{% static 'images/template1.png' %}" alt="Klasik"></div>
            <div class="meta"><p>Klasik</p><span class="badge">Önerilen</span></div>
          </label>
          <label class="template-card" data-template="modern">
            <input type="radio" name="template" value="modern">
            <div class="thumb"><img src="{% static 'images/template2.png' %}" alt="Modern"></div>
            <div class="meta"><p>Modern</p></div>
          </label>
          <label class="template-card" data-template="minimal">
            <input type="radio" name="template" value="minimal">
            <div class="thumb"><img src="{% static 'images/template3.png' %}" alt="Minimal"></div>
            <div class="meta"><p>Minimal</p></div>
          </label>
        </div>
      </div>

      <!-- Step 2: Basic Info -->
      <form id="step1-form" class="wizard-step step-1 hidden" data-step="2" novalidate>
        <div class="step-head">
          <h2>Temel Bilgiler</h2>
          <p class="muted">Başlık, tarih ve saat zorunludur. Konum ve mesaj isteğe bağlı.</p>
        </div>

        <label for="eventTitle">Davet Başlığı</label>
        <input type="text" id="eventTitle" required placeholder="Örn: Ahmet & Ayşe Düğünü" autocomplete="off">

        <div class="form-row">
          <div>
            <label for="eventDate">Tarih</label>
            <input type="date" id="eventDate" required>
          </div>
          <div>
            <label for="eventTime">Saat</label>
            <input type="time" id="eventTime" required>
          </div>
        </div>

        <label for="eventLocation">Konum</label>
        <input type="text" id="eventLocation" placeholder="Örn: Sahil Düğün Bahçesi, İstanbul">

        <label for="eventMessage">Açıklama</label>
        <textarea id="eventMessage" rows="3" placeholder="Kısa bir davet mesajı..."></textarea>
      </form>

      <!-- Step 3: Settings (Security / Reminders / Appearance) -->
      <div class="wizard-step step-2 hidden" data-step="3" id="step-settings">
        <div class="step-head">
          <h2 class="step-title">Davet Ayarları</h2>
          <p class="muted">Güvenlik, hatırlatıcı ve görünüm ayarlarını yapılandırın.</p>
        </div>

        <div class="settings-grid">
          <!-- Security -->
          <section class="card soft security-card" aria-labelledby="sec-title">
            <header class="card-head">
              <div class="head-left">
                <div class="icon-badge" aria-hidden="true"><i class="fas fa-shield-alt"></i></div>
                <div>
                  <h3 id="sec-title">Güvenlik</h3>
                  <p class="muted">Davetiyeyi şifre ile koruyun, erişim süresi belirleyin.</p>
                </div>
              </div>
            </header>

            <div class="card-body">
              <div class="line">
                <label class="switch">
                  <input type="checkbox" id="protectToggle" aria-controls="passwordRow" aria-expanded="false">
                  <span class="slider"></span>
                </label>
                <div class="line-col">
                  <strong>Şifre koruma</strong>
                  <span class="muted xs">Gizli erişim bağlantıları şifre sormaz.</span>
                </div>
              </div>

              <div class="grid-2 gap hidden" id="passwordRow">
                <div>
                  <label for="invitePassword">Şifre</label>
                  <input type="text" id="invitePassword" placeholder="En az 6 karakter" autocomplete="new-password">
                </div>
                <div>
                  <label>Güç</label>
                  <div id="pwdStrength" class="strength-bar" aria-label="Şifre Gücü"><span></span></div>
                </div>
              </div>

              <hr class="sep">

              <div class="line">
                <label class="switch">
                  <input type="checkbox" id="expToggle" aria-controls="expiryRow" aria-expanded="false">
                  <span class="slider"></span>
                </label>
                <div class="line-col">
                  <strong>Süre sınırlaması</strong>
                  <span class="muted xs">Belirlenen tarihten sonra davetiye erişilemez.</span>
                </div>
              </div>

              <div class="grid-2 gap hidden" id="expiryRow">
                <div>
                  <label for="expireDate">Son erişim tarihi</label>
                  <input type="datetime-local" id="expireDate">
                </div>
                <div>
                  <label>Durum</label>
                  <div class="kbd" id="expireHint">—</div>
                </div>
              </div>
            </div>
          </section>

          <!-- Reminders -->
          <section class="card soft rem-card" aria-labelledby="rem-title">
            <header class="card-head">
              <div class="head-left">
                <div class="icon-badge" aria-hidden="true"><i class="fas fa-bell"></i></div>
                <div>
                  <h3 id="rem-title">Hatırlatıcılar</h3>
                  <p class="muted">Etkinlikten önce otomatik bilgilendirme gönder.</p>
                </div>
              </div>
              <div class="head-right">
                <label class="switch">
                  <input type="checkbox" id="remindersEnabled">
                  <span class="slider"></span>
                </label>
              </div>
            </header>

            <div class="card-body" id="reminderControls">
              <div class="quota" aria-live="polite">
                <div class="quota-top">
                  <span class="label">Kalan hak</span>
                  <span class="value"><strong id="remindersLeftValue">—</strong></span>
                </div>
                <div class="quota-bar" aria-hidden="true">
                  <div class="quota-fill" id="remindersLeftBar" style="width:0%"></div>
                </div>
              </div>

              <div class="timeline">
                <label class="chip"><input type="checkbox" class="reminderPreset" value="-1d" checked> <span>1 gün önce</span></label>
                <label class="chip"><input type="checkbox" class="reminderPreset" value="-3h" checked> <span>3 saat önce</span></label>
                <label class="chip"><input type="checkbox" class="reminderPreset" value="-30m"> <span>30 dk önce</span></label>
                <div class="custom-inline">
                  <label for="reminderCustom" class="muted">Özel</label>
                  <input type="number" id="reminderCustom" min="1" placeholder="dakika" inputmode="numeric">
                  <span class="muted">önce</span>
                </div>
              </div>

              <div class="channels">
                <span class="channels-title">Kanal</span>
                <div class="channel-badges">
                  <label class="badge"><input type="checkbox" class="reminderChannel" value="email" checked> <i class="fas fa-envelope"></i> E-posta</label>
                  <label class="badge"><input type="checkbox" class="reminderChannel" value="sms"> <i class="fas fa-sms"></i> SMS</label>
                  <label class="badge"><input type="checkbox" class="reminderChannel" value="whatsapp"> <i class="fab fa-whatsapp"></i> WhatsApp</label>
                </div>
                <p class="muted xs">Paket dışı kanallar otomatik devre dışı kalır.</p>
              </div>

              <div class="extras">
                <label class="line"><input type="checkbox" id="smartRetry"> <span>Yanıt vermeyenlere <strong>24 saat</strong> sonra 1 kez daha dene</span></label>
                <div class="quiet-hours">
                  <span class="muted">Sessiz saatler</span>
                  <div class="qh-inline">
                    <select id="qhStart"><option>21:00</option><option>22:00</option><option selected>23:00</option></select>
                    <span class="sep">–</span>
                    <select id="qhEnd"><option>06:00</option><option selected>07:00</option><option>08:00</option></select>
                  </div>
                </div>
              </div>

              <div class="warn hidden" id="reminderWarning"><i class="fas fa-exclamation-triangle"></i> Kota yetersiz. Seçimleri azaltın ya da paketi yükseltin.</div>
            </div>
          </section>

          <!-- Appearance -->
          <section class="card soft appearance-card" aria-labelledby="app-title">
            <header class="card-head">
              <div class="head-left">
                <div class="icon-badge" aria-hidden="true"><i class="fas fa-palette"></i></div>
                <div>
                  <h3 id="app-title">Görünüm</h3>
                  <p class="muted">Tema ve dil ayarları.</p>
                </div>
              </div>
            </header>
            <div class="card-body grid-2 gap">
              <div>
                <label for="themeSelect">Tema</label>
                <select id="themeSelect">
                  <option value="light" selected>Aydınlık</option>
                  <option value="dark">Karanlık</option>
                </select>
              </div>
              <div>
                <label for="langSelect">Dil</label>
                <select id="langSelect">
                  <option value="tr" selected>Türkçe</option>
                  <option value="en">English</option>
                </select>
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- Step 4: Message & Multi-Channel Preview -->
      <div class="wizard-step step-3 hidden" data-step="4">
        <div class="step-head">
          <h2>Mesaj & Kanal Önizlemesi</h2>
          <p class="muted">Metni düzenledikçe SMS, e‑posta ve WhatsApp kartları canlı güncellenir.</p>
        </div>

        <label for="broadcastMessage">Gönderilecek Mesaj</label>
        <textarea id="broadcastMessage" rows="3" placeholder="Kısa bir davet mesajı yazın..."></textarea>
        <small class="muted" id="smsCounterBar"><span class="count">0</span>/<span class="limit">160</span> <span class="segments">(1 SMS)</span></small>

        <div class="message-preview">
          <div class="mp-header">
            <div class="mp-tabs" role="tablist">
              <button class="mp-tab active" data-target="#mp-sms" role="tab" aria-selected="true">SMS</button>
              <button class="mp-tab" data-target="#mp-email" role="tab">E-posta</button>
              <button class="mp-tab" data-target="#mp-wa" role="tab">WhatsApp</button>
            </div>
            <div class="mp-tools">
              <button class="mp-copy" id="copyMsgBtn" title="Mesajı kopyala" aria-label="Mesajı kopyala"><i class="fas fa-copy"></i></button>
            </div>
          </div>

          <div class="mp-panels">
            <div class="mp-panel active" id="mp-sms" role="tabpanel">
              <div class="mp-device phone" aria-label="SMS Önizleme">
                <div class="statusbar"></div>
                <div class="chat-bubble from-me" id="mp-sms-text">[SMS önizleme]</div>
              </div>
              <div class="mp-hints"><small>Unicode/emojiler SMS segment sayısını artırabilir.</small></div>
            </div>

            <div class="mp-panel" id="mp-email" role="tabpanel">
              <div class="mail-card">
                <div class="mail-header">
                  <div class="avatar">DJ</div>
                  <div class="meta">
                    <strong>Gönderen:</strong> no-reply@davetjet.com<br>
                    <strong>Konu:</strong> <span id="mp-email-subject">[Konu]</span>
                  </div>
                </div>
                <div class="mail-body" id="mp-email-body">[E-posta gövdesi önizleme]</div>
              </div>
            </div>

            <div class="mp-panel" id="mp-wa" role="tabpanel">
              <div class="mp-device whatsapp" aria-label="WhatsApp Önizleme">
                <div class="wa-header"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                <div class="wa-body"><div class="wa-bubble me" id="mp-wa-text">[WhatsApp önizleme]</div></div>
              </div>
              <div class="mp-hints"><small>Uzun bağlantılar kısaltılırsa mesaj derli toplu görünür.</small></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 5: Share -->
      <div class="wizard-step step-4 hidden" data-step="5">
        <div class="step-head">
          <h2>Paylaş & Aksiyonlar</h2>
          <p class="muted">Bağlantıyı paylaşın, QR kodla hızlıca iletin veya yayınlayın.</p>
        </div>

        <div class="share-actions pretty">
          <!-- Link Card -->
          <section class="share-card glass">
            <header><i class="fas fa-link"></i> Paylaşılabilir Bağlantı</header>
            <div class="link-row">
              <input type="text" id="shareLink" readonly value="https://davetjet.com/—" aria-label="Paylaşılabilir bağlantı">
              <button class="btn-ghost" id="copyShare"><i class="fas fa-copy"></i> Kopyala</button>
            </div>
          </section>

          <!-- QR + Quick -->
          <section class="share-card glass">
            <header><i class="fas fa-bolt"></i> Hızlı Aksiyon</header>
            <div class="quick-row">
              <button class="pill whatsapp"><i class="fab fa-whatsapp"></i> WhatsApp</button>
              <button class="pill email"><i class="fas fa-envelope"></i> E-posta</button>
              <button class="pill sms"><i class="fas fa-sms"></i> SMS</button>
            </div>
            <div class="qr-row">
              <img src="{% static 'images/qr-placeholder.png' %}" class="qr-code" alt="QR">
            </div>
          </section>

          <!-- Final -->
          <section class="share-card glass">
            <header><i class="fas fa-flag-checkered"></i> Son</header>
            <div class="final-row">
              <button type="button" class="btn" id="saveDraftBtn">Taslağa Kaydet</button>
              <button type="button" class="btn btn--primary" id="finishBtn">Yayınla</button>
              <!-- Step 5: Final row içine EK -->
              <button type="button" class="btn btn--primary hidden" id="updateBtn">Güncelle</button>
            </div>
            <small class="muted xs">Taslak; alıcı eklenmeden kaydedilir.</small>
          </section>
        </div>
      </div>

      <!-- Nav -->
      <div class="wizard-nav">
        <button type="button" class="btn back-btn" id="prevBtn" disabled>Geri</button>
        <button type="button" class="btn next-btn" id="nextBtn">İleri</button>
         <!-- EK: Taslaklar'ı açan buton (uygun yere koy) -->
        <button type="button" class="btn" id="openDraftsBtn">
          Taslaklar
        </button>

      </div>
    </div>

    <!-- RIGHT: Live Preview -->
    <aside class="wizard-preview-area" id="previewArea" data-template="classic">
      <div class="preview-header">
        <h3>Canlı Önizleme</h3>
        <button id="expandPreviewBtn" title="Tam ekran önizleme" aria-label="Tam ekran önizleme"><i class="fas fa-expand"></i></button>
      </div>
      <div class="preview-frame-wrapper">
        <iframe id="livePreview" frameborder="0" title="Davetiye Canlı Önizleme"></iframe>
      </div>
    </aside>
  </div>

  <!-- Fullscreen modal -->
  <div id="fullscreenPreviewModal" class="fullscreen-modal hidden" role="dialog" aria-modal="true" aria-labelledby="fs-title">
    <div class="modal-header">
      <h4 id="fs-title">Davetiye Önizleme</h4>
      <button id="closeFullscreenPreview" aria-label="Kapat">&times;</button>
    </div>
    <div class="modal-body">
      <iframe id="fullscreenIframe" frameborder="0" title="Davetiye Tam Ekran Önizleme"></iframe>
    </div>
  </div>

  <!-- EK: Taslaklar Modal -->
  <div id="draftsModal" class="fullscreen-modal hidden" role="dialog" aria-modal="true" aria-labelledby="drafts-title">
    <!-- draftsModal içinde YERİNE GEÇER -->
<div class="drafts-modal-panel" role="document">
  <div class="dm-head">
    <div class="title">
      <i class="fas fa-file-alt"></i> Taslaklar
    </div>
    <button type="button" class="dm-close" id="closeDraftsModal" aria-label="Kapat">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <div class="dm-body">
    <!-- boşken gösterilecek -->
    <div id="draftsEmpty" class="dm-empty hidden">
      <div class="bubble">
        <i class="fas fa-inbox"></i>
      </div>
      <div class="text">
        <strong>Henüz taslak yok</strong>
        <span class="muted">Davet oluşturduğunda burada görünecek.</span>
      </div>
    </div>

    <!-- yükleme iskeleti -->
    <div id="draftsSkeleton" class="drafts-grid skeleton">
      <div class="draft-card sk"></div>
      <div class="draft-card sk"></div>
      <div class="draft-card sk"></div>
    </div>

    <!-- gerçek liste -->
    <div id="draftsGrid" class="drafts-grid"></div>
  </div>

  <div class="dm-foot">
    <button type="button" class="btn btn--ghost" id="newDraftBtn">
      <i class="fas fa-plus"></i> Yeni taslak
    </button>
  </div>
</div>

  </div>

 
</div>
{% endblock %}

{% block extra_js %}
{% if inv_json %}
<script>window.INV_META = {{ inv_json|safe }};</script>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ====== Elements
  let currentStep = 0;
  const steps = document.querySelectorAll(".wizard-step");
  const progressSteps = document.querySelectorAll(".wizard-progress .step");
  const progressBar = document.querySelector(".wizard-progressbar .bar");
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const finishBtn = document.getElementById("finishBtn");
  const saveDraftBtn = document.getElementById("saveDraftBtn");
  const updateBtn = document.getElementById("updateBtn");

  const previewIframe = document.getElementById("livePreview");
  const fullscreenIframe = document.getElementById("fullscreenIframe");

  // Form fields
  const eventTitle = document.getElementById("eventTitle");
  const eventDate = document.getElementById("eventDate");
  const eventTime = document.getElementById("eventTime");
  const eventLocation = document.getElementById("eventLocation");
  const eventMessage = document.getElementById("eventMessage");

  // Settings
  const protectToggle = document.getElementById("protectToggle");
  const passwordRow = document.getElementById("passwordRow");
  const invitePassword = document.getElementById("invitePassword");
  const expToggle = document.getElementById("expToggle");
  const expiryRow = document.getElementById("expiryRow");
  const expireDate = document.getElementById("expireDate");
  const pwdStrength = document.getElementById("pwdStrength")?.querySelector("span");
  const expireHint = document.getElementById("expireHint");

  // Message preview
  const broadcastMessage = document.getElementById("broadcastMessage");
  const smsBar = document.getElementById("smsCounterBar");
  const smsCountEl = smsBar?.querySelector(".count");
  const smsSegsEl = smsBar?.querySelector(".segments");
  const smsLimitEl = smsBar?.querySelector(".limit");

  // Share
  const shareLink = document.getElementById("shareLink");
  const copyShare = document.getElementById("copyShare");

  // Drafts modal (opsiyonel)
  const draftsModal = document.getElementById("draftsModal");
  const openDraftsBtn = document.getElementById("openDraftsBtn");
  const closeDraftsModal = document.getElementById("closeDraftsModal");
  const draftsGrid = document.getElementById("draftsGrid");

  // URL paramları + sunucudan gelen meta
  const params = new URLSearchParams(location.search);
  const bootMeta = window.INV_META || null;
  let editId = params.get("inv") || (bootMeta ? String(bootMeta.id) : null); // LET olmalı (sonradan set ediyoruz)
  const forcedDraft = params.get("draft") === "1" || (bootMeta ? bootMeta.is_draft : false);
  let isEditing = !!editId;
  let isEditingDraft = forcedDraft || !!bootMeta?.is_draft;

  // ===== Helpers
  const getCSRF = () => {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : "";
  };

  const setProgress = (index) => {
    const pct = ((index) / (steps.length - 1)) * 100;
    progressBar && (progressBar.style.width = pct + "%");
    progressSteps.forEach((p, i) => {
      p.classList.toggle("active", i === index);
      p.setAttribute("aria-selected", i === index ? "true" : "false");
      p.tabIndex = i === index ? 0 : -1;
    });
  };

  function toast(msg){
    let t = document.querySelector('.mini-toast');
    if(!t){
      t = document.createElement('div');
      t.className = 'mini-toast';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    requestAnimationFrame(()=>{
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1800);
    });
  }

  // ===== Reminders & Channels STATE + HELPERS (TEK KAYNAK)
  const rem = {
    enabled: false,
    presets: new Set(),                 // "-1d", "-3h", "-30m"
    customMinutes: null,                // sayı (dk)
    channels: { email: true, sms: false, whatsapp: false },
    quietHours: { start: "23:00", end: "07:00" },
    smartRetry: false,
    quota: { max: 3, used: 0 },
  };

  // UI referansları
  const remEnabledEl = document.getElementById("remindersEnabled");
  const remCtrEl     = document.getElementById("reminderControls");
  const presetEls    = Array.from(document.querySelectorAll(".reminderPreset"));
  const customEl     = document.getElementById("reminderCustom");
  const channelEls   = Array.from(document.querySelectorAll(".reminderChannel"));
  const qhStartEl    = document.getElementById("qhStart");
  const qhEndEl      = document.getElementById("qhEnd");
  const smartRetryEl = document.getElementById("smartRetry");
  const quotaValEl   = document.getElementById("remindersLeftValue");
  const quotaBarEl   = document.getElementById("remindersLeftBar");
  const quotaWarnEl  = document.getElementById("reminderWarning");

  function tokenToMinutes(t){
    if (!t) return null;
    const m = String(t).match(/^-?(\d+)([dhm])$/i);
    if (!m) return null;
    const n = parseInt(m[1],10); const u = m[2].toLowerCase();
    return u === "d" ? n*1440 : u === "h" ? n*60 : n;
  }

  function buildReminderConfig(){
    const arr = [];
    rem.presets.forEach(tok => {
      const mins = tokenToMinutes(tok);
      if (mins && mins > 0) arr.push(mins);
    });
    if (customEl && customEl.value){
      const cm = parseInt(customEl.value,10);
      if (!Number.isNaN(cm) && cm > 0) arr.push(cm);
    } else if (rem.customMinutes && rem.customMinutes > 0){
      arr.push(rem.customMinutes);
    }
    return Array.from(new Set(arr)).sort((a,b)=>a-b);
  }

  function getDeliverySettings(){
    return {
      email: !!rem.channels.email,
      sms: !!rem.channels.sms,
      whatsapp: !!rem.channels.whatsapp,
      quiet_hours: { ...rem.quietHours },
      smart_retry: !!rem.smartRetry,
    };
  }

  function applyRemindersUIEnabled(on){
    if (!remCtrEl) return;
    remCtrEl.classList.toggle("is-off", !on);
    remCtrEl.querySelectorAll("input,select,button").forEach(el=>{
      if (el === remEnabledEl) return;
      el.disabled = !on;
    });
  }

  function updateQuotaUI(){
    const cfg = buildReminderConfig();
    rem.quota.used = cfg.length;
    const left = Math.max(0, rem.quota.max - rem.quota.used);
    if (quotaValEl) quotaValEl.textContent = String(left);
    if (quotaBarEl){
      const pct = rem.quota.max ? (Math.min(rem.quota.used, rem.quota.max) / rem.quota.max)*100 : 0;
      quotaBarEl.style.width = `${pct}%`;
    }
    if (quotaWarnEl){
      quotaWarnEl.classList.toggle("hidden", !(rem.enabled && rem.quota.used > rem.quota.max));
    }
  }

  function validateReminders(){
    if (!rem.enabled) return true;
    const cfg = buildReminderConfig();
    const ds = getDeliverySettings();
    const channelAny = ds.email || ds.sms || ds.whatsapp;
    if (cfg.length === 0){ toast("Hatırlatıcı zamanı seçin (preset veya özel)."); return false; }
    if (!channelAny){ toast("En az bir hatırlatma kanalı seçin."); return false; }
    if (rem.quota.used > rem.quota.max){ toast("Kota yetersiz. Seçimi azaltın ya da paketi yükseltin."); return false; }
    return true;
  }

  function ensureRemindersValidOrThrow(){
    if (!validateReminders()){
      const e = new Error("REM_INVALID"); e.code = "REM_INVALID"; throw e;
    }
  }

  (function initRemindersFromMeta(){
    const meta = window.INV_META || null;

    rem.enabled = !!meta?.reminders;
    if (remEnabledEl) remEnabledEl.checked = rem.enabled;

    const cfg = Array.isArray(meta?.reminder_config) ? meta.reminder_config : [];
    const presetMapMinutes = { "-1d":1440, "-3h":180, "-30m":30 };
    presetEls.forEach(cb=>{
      const mins = tokenToMinutes(cb.value);
      const on = mins && cfg.includes(mins);
      cb.checked = !!on;
      if (on) rem.presets.add(cb.value);
    });
    const others = cfg.filter(v => !Object.values(presetMapMinutes).includes(v));
    if (customEl && others.length){
      customEl.value = String(others[0]);
      rem.customMinutes = others[0];
    }

    const ds = meta?.delivery_settings || {};
    rem.channels.email = ds.email !== false; // default true
    rem.channels.sms = !!ds.sms;
    rem.channels.whatsapp = !!ds.whatsapp;
    channelEls.forEach(cb=>{
      if (cb.value in rem.channels) cb.checked = !!rem.channels[cb.value];
    });

    if (ds.quiet_hours){
      rem.quietHours.start = ds.quiet_hours.start || rem.quietHours.start;
      rem.quietHours.end   = ds.quiet_hours.end   || rem.quietHours.end;
    }
    if (qhStartEl) qhStartEl.value = rem.quietHours.start;
    if (qhEndEl)   qhEndEl.value   = rem.quietHours.end;

    rem.smartRetry = !!ds.smart_retry;
    if (smartRetryEl) smartRetryEl.checked = rem.smartRetry;

    if (typeof meta?.max_reminders === "number"){
      rem.quota.max = meta.max_reminders;
    }

    applyRemindersUIEnabled(rem.enabled);
    updateQuotaUI();
  })();

  // ===== Template load + bindings
  const loadTemplate = (name) => {
    fetch(`/static/inv-temps/${name}.html`)
      .then(r => r.text())
      .then(html => {
        const onLoad = () => {
          pushFormIntoIframe(previewIframe);
          enableIframeSync(previewIframe, null);
          previewIframe.removeEventListener('load', onLoad);
        };
        previewIframe.addEventListener('load', onLoad);
        previewIframe.srcdoc = html;
      });
  };

  document.querySelectorAll(".template-card").forEach(card => {
    card.addEventListener("click", () => {
      document.querySelectorAll(".template-card").forEach(c => c.classList.remove("selected"));
      card.classList.add("selected");
      loadTemplate(card.dataset.template);
    });
    card.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault(); card.click();
      }
    });
  });
  loadTemplate("classic");

  // ===== Progress / Nav
  document.querySelectorAll('.wizard-progress .step').forEach((btn, i) => {
    btn.addEventListener('click', () => {
      if (currentStep === 1 && i > 1 && !validateBasic()) return;
      showStep(i);
    });
  });

  const showStep = (index) => {
    steps.forEach((s, i) => s.classList.toggle("hidden", i !== index));
    setProgress(index);
    prevBtn.disabled = index === 0;
    nextBtn.classList.toggle("hidden", index === steps.length - 1);
    currentStep = index;
  };

  const validateBasic = () => {
    if (currentStep !== 1) return true;
    const dateStr = eventDate.value;
    const timeStr = eventTime.value;
    if (!eventTitle.value.trim() || !dateStr || !timeStr) { toast("Lütfen başlık, tarih ve saati doldurun."); return false; }
    const now = new Date();
    const dt = new Date(`${dateStr}T${timeStr}:00`);
    const threeMonths = new Date(); threeMonths.setMonth(now.getMonth() + 3);
    if (isNaN(dt)) { toast("Geçerli bir tarih/saat giriniz."); return false; }
    if (dt < now) { toast("Geçmiş bir tarih/saat olamaz."); return false; }
    if (dt > threeMonths) { toast("Tarih 3 aydan fazla ileri olamaz."); return false; }
    return true;
  };

  prevBtn.addEventListener("click", () => currentStep > 0 && showStep(currentStep - 1));
  nextBtn.addEventListener("click", () => {
    if (currentStep === 1 && !validateBasic()) return;
    showStep(Math.min(currentStep + 1, steps.length - 1));
  });

  document.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.key === 'ArrowRight') nextBtn.click();
    if(e.ctrlKey && e.key === 'ArrowLeft') prevBtn.click();
  });

  // ===== Settings UI
  protectToggle?.addEventListener("change", () => {
    const on = !!protectToggle.checked;
    passwordRow.classList.toggle("hidden", !on);
    protectToggle.setAttribute('aria-expanded', on ? 'true' : 'false');
  });
  expToggle?.addEventListener("change", () => {
    const on = !!expToggle.checked;
    expiryRow.classList.toggle("hidden", !on);
    expToggle.setAttribute('aria-expanded', on ? 'true' : 'false');
  });
  invitePassword?.addEventListener("input", () => {
    const v = invitePassword.value || "";
    const score = Math.max(0, Math.min(100, v.length * 12 + (/[A-Z]/.test(v) ? 20 : 0) + (/\d/.test(v) ? 15 : 0) + (/[^A-Za-z0-9]/.test(v) ? 15 : 0)));
    if (pwdStrength) pwdStrength.style.width = score + "%";
  });
  expireDate?.addEventListener("input", () => {
    const dt = new Date(expireDate.value);
    if (isNaN(dt)) { if (expireHint) expireHint.textContent = "—"; return; }
    const leftMs = dt - new Date();
    if (leftMs <= 0) expireHint.textContent = "Süre doldu";
    else {
      const hours = Math.floor(leftMs / 36e5);
      expireHint.textContent = `~ ${hours} saat kaldı`;
    }
  });

  // ===== Form -> iframe + Multi-channel
  [eventTitle, eventDate, eventTime, eventLocation, eventMessage].forEach(inp => {
    inp && inp.addEventListener("input", () => {
      pushFormIntoIframe(previewIframe);
      refreshMultiChannel();
    });
  });
  broadcastMessage?.addEventListener("input", () => {
    refreshMultiChannel();
  });

  function pushFormIntoIframe(iframe) {
    const doc = iframe.contentDocument;
    if (!doc) return;
    const map = {
      "event-title": eventTitle?.value || "Etkinlik Başlığı",
      "event-date": eventDate?.value || "",
      "event-time": eventTime?.value || "",
      "event-location": eventLocation?.value || "",
      "event-message": eventMessage?.value || ""
    };
    Object.entries(map).forEach(([id, val]) => {
      const el = doc.getElementById(id);
      if (el) el.textContent = val;
    });
  }

  function enableIframeSync(sourceIframe, mirrorIframe) {
    const doc = sourceIframe.contentDocument;
    if (!doc) return;
    const pairs = {
      "event-title": eventTitle,
      "event-date": eventDate,
      "event-time": eventTime,
      "event-location": eventLocation,
      "event-message": eventMessage
    };
    Object.entries(pairs).forEach(([id, input]) => {
      const el = doc.getElementById(id);
      if (el && el.isContentEditable) {
        el.addEventListener("input", () => {
          input.value = el.textContent.trim();
          if (mirrorIframe && mirrorIframe.contentDocument) {
            const other = mirrorIframe.contentDocument.getElementById(id);
            if (other) other.textContent = el.textContent.trim();
          }
          refreshMultiChannel();
        });
      }
    });
  }

  function refreshMultiChannel() {
    const title = eventTitle?.value || "Etkinlik";
    const date = eventDate?.value || "";
    const time = eventTime?.value || "";
    const loc = eventLocation?.value || "";
    const baseMsg = eventMessage?.value || "";
    const extra = broadcastMessage?.value || "";
    const compiled = `${title}\n${date} ${time}\n${loc}\n${extra || baseMsg}`.trim();

    const smsNode = document.getElementById("mp-sms-text");
    if (smsNode) smsNode.replaceChildren(document.createTextNode(compiled));
    updateSmsCounter(compiled);

    const subjEl = document.getElementById("mp-email-subject");
    const bodyEl = document.getElementById("mp-email-body");
    subjEl && subjEl.replaceChildren(document.createTextNode(`${title} - Davet`));
    bodyEl && bodyEl.replaceChildren(document.createTextNode(`${extra || baseMsg}\n\nTarih: ${date} ${time}\nYer: ${loc}`));

    const waNode = document.getElementById("mp-wa-text");
    waNode && waNode.replaceChildren(document.createTextNode(compiled));
  }

  function updateSmsCounter(text) {
    if (!smsCountEl || !smsLimitEl || !smsSegsEl) return;
    const isUnicode = /[^\u0000-\u007F]/.test(text);
    const perSeg = isUnicode ? 70 : 160;
    const len = text.length;
    const segs = Math.max(1, Math.ceil(len / perSeg));
    smsCountEl.textContent = len;
    smsLimitEl.textContent = perSeg;
    smsSegsEl.textContent = `(${segs} SMS)`;
  }

  (function setupTabs(){
    const tabs = document.querySelectorAll(".mp-tab");
    const panels = document.querySelectorAll(".mp-panel");
    function setActive(btn) {
      tabs.forEach(t=>t.classList.remove("active"));
      panels.forEach(p=>p.classList.remove("active"));
      btn.classList.add("active");
      const t = document.querySelector(btn.dataset.target);
      t && t.classList.add("active");
    }
    tabs.forEach(btn => btn.addEventListener("click", ()=> setActive(btn)));
  })();

  document.getElementById("copyMsgBtn")?.addEventListener("click", ()=>{
    const val = document.getElementById("mp-sms-text").textContent || "";
    navigator.clipboard.writeText(val).then(()=> toast("Mesaj kopyalandı!"));
  });

  copyShare?.addEventListener("click", () => {
    navigator.clipboard.writeText(shareLink.value).then(()=> toast("Bağlantı kopyalandı"));
  });

  // ===== Fullscreen Preview
  const expandBtn = document.getElementById("expandPreviewBtn");
  const expandModal = document.getElementById("fullscreenPreviewModal");
  const closeFullscreenBtn = document.getElementById("closeFullscreenPreview");

  expandBtn?.addEventListener("click", () => {
    const html = previewIframe.contentDocument?.documentElement?.outerHTML || "";
    const onFsLoad = () => {
      pushFormIntoIframe(fullscreenIframe);
      enableIframeSync(fullscreenIframe, previewIframe);
      fullscreenIframe.removeEventListener('load', onFsLoad);
    };
    fullscreenIframe.addEventListener('load', onFsLoad);
    fullscreenIframe.srcdoc = html;
    expandModal.classList.remove("hidden");
  });

  closeFullscreenBtn?.addEventListener("click", () => expandModal.classList.add("hidden"));

  // ===== UPDATE (Publish edilmiş davetiyeyi güncelle)
  updateBtn?.addEventListener("click", async () => {
    if (!editId) return;
    const old = updateBtn.textContent;
    updateBtn.disabled = true; updateBtn.textContent = "Güncelleniyor…";
    try{
      ensureRemindersValidOrThrow();
      const payload = {
        name: eventTitle.value.trim(),
        message: eventMessage.value || "",
        invitation_date: (eventDate.value && eventTime.value) ? `${eventDate.value}T${eventTime.value}:00` : null,
        template: document.querySelector(".template-card.selected")?.dataset.template, // yayınlanmışta backend ignore edebilir
        is_password_protected: !!protectToggle?.checked,
        password: protectToggle?.checked ? (invitePassword?.value || "") : "",
        // reminders
        reminders: rem.enabled,
        reminder_config: rem.enabled ? buildReminderConfig() : [],
        reminder_message: (broadcastMessage?.value || eventMessage?.value || "").trim(),
        delivery_settings: getDeliverySettings(),
      };

      const url = `{% url 'invitations:invitation-detail' 0 %}`.replace("0", editId);
      const r = await fetch(url, {
        method: "PATCH",
        headers: { "Content-Type":"application/json", "X-CSRFToken": getCSRF() },
        body: JSON.stringify(payload)
      });
      const data = await r.json().catch(()=> ({}));
      if(!r.ok) throw new Error(data?.detail || "Update failed");
      toast("Güncellendi ✅");
    }catch(e){
      if (e.code !== "REM_INVALID") console.error(e);
      if (e.code !== "REM_INVALID") toast("Güncellenemedi");
    }finally{
      updateBtn.disabled = false; updateBtn.textContent = old;
    }
  });

  // ===== DRAFTS MODAL (opsiyonel)
  openDraftsBtn?.addEventListener("click", async () => {
    document.body.classList.add("modal-open");
    draftsModal.classList.remove("hidden");
    document.getElementById("draftsSkeleton")?.classList.remove("hidden");
    document.getElementById("draftsEmpty")?.classList.add("hidden");
    await loadDrafts();
  });
  function closeDrafts(){ draftsModal.classList.add("hidden"); document.body.classList.remove("modal-open"); }
  closeDraftsModal?.addEventListener("click", closeDrafts);
  draftsModal?.addEventListener("click", (e)=>{ if(e.target === draftsModal) closeDrafts(); });
  document.addEventListener("keydown", (e)=>{ if(e.key === "Escape" && !draftsModal?.classList.contains("hidden")) closeDrafts(); });

  async function loadInvitationById(id){
    const r = await fetch(`/invitations/api/invitations/${id}/`, { headers:{ "X-Requested-With":"XMLHttpRequest" }});
    if(!r.ok) throw new Error("Load failed");
    const data = await r.json();
    hydrateFromData(data);
  }

  async function loadDrafts(){
    const sk = document.getElementById("draftsSkeleton");
    const empty = document.getElementById("draftsEmpty");
    const grid = document.getElementById("draftsGrid");
    sk && sk.classList.remove("hidden");
    empty && empty.classList.add("hidden");
    grid && (grid.innerHTML = "");

    try{
      const r = await fetch("{% url 'invitations:invitation-drafts' %}", { headers: { "X-Requested-With":"XMLHttpRequest" } });
      const list = await r.json();
      sk && sk.classList.add("hidden");

      if(!Array.isArray(list) || list.length === 0){
        empty && empty.classList.remove("hidden");
        grid.innerHTML = "";
        return;
      }

      grid.innerHTML = "";
      list.forEach(item => {
        const el = document.createElement("div");
        el.className = "draft-card";
        const title = item.name || "Adsız Taslak";
        const date = item.invitation_date ? new Date(item.invitation_date) : null;
        const dateStr = date ? `${date.toLocaleDateString()} ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : "—";
        const avatar = (title?.trim()?.charAt(0) || "D").toUpperCase();

        el.innerHTML = `
          <div class="dc-thumb">${avatar}</div>
          <div class="dc-body">
            <div class="dc-title">
              <span>${title}</span>
              <span class="chip">Taslak</span>
            </div>
            <div class="dc-meta">
              <div class="row"><i class="far fa-calendar"></i> ${dateStr}</div>
              <div class="row"><span class="dot"></span> Şablon: ${item.template || "classic"}</div>
            </div>
          </div>
          <div class="dc-foot">
            <div class="left">ID #${item.id}</div>
            <div class="actions">
              <button type="button" class="btn" data-act="open" data-id="${item.id}">
                <i class="fas fa-external-link-alt"></i> Aç
              </button>
              <button type="button" class="btn btn--primary" data-act="promote" data-id="${item.id}">
                <i class="fas fa-upload"></i> Yayınla
              </button>
              <button type="button" class="btn btn--danger" data-act="delete" data-id="${item.id}">
                <i class="fas fa-trash"></i> Sil
              </button>
            </div>
          </div>
        `;
        grid.appendChild(el);
      });

      grid.querySelectorAll(".dc-foot .actions .btn").forEach(btn=>{
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          const act = btn.getAttribute("data-act");
          if(act === "open"){
            // Bu URL'i kendi edit view URL adına göre düzelt
            window.location.href = "{% url 'core:edit-invitation-api' 0 %}".replace("0", id);
          }
          if(act === "promote"){
            const old = btn.textContent; btn.disabled = true; btn.textContent = "Yayınlanıyor…";
            try{
              const r = await fetch(`{% url 'invitations:invitation-draft-promote' 0 %}`.replace("0", id), {
                method:"POST",
                headers:{ "X-CSRFToken": getCSRF() }
              });
              if(!r.ok) throw new Error("Promote failed");
              const data = await r.json().catch(()=> ({}));
              if (data?.share_url && shareLink) shareLink.value = data.share_url;
              showStep(4);
              toast("Taslak yayınlandı ✅");
              btn.closest(".draft-card")?.remove();
            }catch(e){
              console.error(e); toast("Yayınlama başarısız.");
            }finally{
              btn.disabled = false; btn.textContent = old;
            }
          }
          if(act === "delete"){
            if(!confirm("Taslağı silmek istediğine emin misin?")) return;
            try{
              const r = await fetch(`{% url 'invitations:invitation-draft-delete' 0 %}`.replace("0", id), {
                method:"DELETE",
                headers:{ "X-CSRFToken": getCSRF() }
              });
              if(r.status === 204){ btn.closest(".draft-card")?.remove(); toast("Taslak silindi"); }
              else { toast("Silinemedi"); }
            }catch(e){ console.error(e); toast("Silme başarısız"); }
          }
        });
      });

    }catch(e){
      console.error(e);
      document.getElementById("draftsSkeleton")?.classList.add("hidden");
      draftsGrid.innerHTML = `<div class="muted">Taslaklar yüklenemedi.</div>`;
    }
  }

  // ===== SAVE DRAFT (POST or PATCH)
// (ESKİ)
// try {
//   ensureRemindersValidOrThrow();   // <-- TASLAKTA KALDIR
//   const payload = { ... };
// } catch(e) { ... }

// (YENİ)
saveDraftBtn?.addEventListener("click", async () => {
  const old = saveDraftBtn.textContent;
  saveDraftBtn.disabled = true; saveDraftBtn.textContent = "Kaydediliyor…";
  try{
    // Taslakta hatırlatıcı validasyonu YOK
    const payload = {
      name: eventTitle?.value || "Yeni Davetiye",
      message: eventMessage?.value || "",
      invitation_date: (eventDate?.value && eventTime?.value) ? `${eventDate.value}T${eventTime.value}:00` : null,
      template: document.querySelector(".template-card.selected")?.dataset.template || "classic",
      is_draft: true,
      is_password_protected: !!protectToggle?.checked,
      password: protectToggle?.checked ? (invitePassword?.value || "") : "",
      // Hatırlatıcı/kanal alanları her zaman gönderelim
      reminders: rem.enabled,
      reminder_config: buildReminderConfig(),
      reminder_message: (broadcastMessage?.value || eventMessage?.value || "").trim(),
      delivery_settings: getDeliverySettings(),
    };

    let r;
    if (editId) {
      r = await fetch(`{% url 'invitations:invitation-detail' 0 %}`.replace("0", editId), {
        method: "PATCH",
        headers: { "Content-Type":"application/json", "X-CSRFToken": getCSRF() },
        body: JSON.stringify(payload)
      });
    } else {
      r = await fetch("{% url 'core:create-invitation-api' %}", {
        method: "POST",
        headers: { "Content-Type":"application/json", "X-CSRFToken": getCSRF() },
        body: JSON.stringify(payload)
      });
    }

    const data = (r.status === 204) ? {} : await r.json().catch(()=> ({}));
    if (!r.ok) throw new Error(data?.detail || `HTTP ${r.status}`);

    // ilk oluşturma sonrası URL’yi inv paramıyla güncelle
    if (!editId && data?.id) {
      editId = String(data.id);
      const qs = new URLSearchParams({ inv: editId, draft: "1" });
      history.replaceState(null, "", `${location.pathname}?${qs.toString()}`);
    }

    if (data?.share_url || data?.url || data?.public_url || data?.link) {
      shareLink.value = data.share_url || data.url || data.public_url || data.link;
    }

    toast(editId ? "Taslak güncellendi ✅" : "Taslak kaydedildi ✅");
  } catch (err) {
    console.error("[draft save] error:", err);
    toast("Taslak kaydedilemedi.");
  } finally {
    saveDraftBtn.disabled = false; saveDraftBtn.textContent = old;
  }
});


  // ===== PUBLISH (Yayınla)
// === YERİNE KOY — Publish handler ===
// === PUBLİSH HANDLER (tamamen değiştir) ===
finishBtn?.addEventListener("click", async (e) => {
  e.preventDefault();

  if (!eventTitle.value.trim() || !eventDate.value || !eventTime.value) {
    toast("Yayınlamak için başlık, tarih ve saat gerekli."); showStep(1); return;
  }
  if (!validateReminders()) return;

  const basePayload = {
    name: eventTitle.value.trim(),
    message: eventMessage.value || "",
    invitation_date: `${eventDate.value}T${eventTime.value}:00`,
    template: document.querySelector(".template-card.selected")?.dataset.template || "classic",
    is_password_protected: !!protectToggle?.checked,
    password: protectToggle?.checked ? (invitePassword?.value || "") : "",
    // reminders
    reminders: rem.enabled,
    reminder_config: rem.enabled ? buildReminderConfig() : [],
    reminder_message: (broadcastMessage?.value || eventMessage?.value || "").trim(),
    // delivery
    delivery_settings: getDeliverySettings(),
  };

  const old = finishBtn.textContent;
  finishBtn.disabled = true; finishBtn.textContent = "Yayınlanıyor…";

  try {
    if (isEditing && isEditingDraft && editId) {
      // A) VAR OLAN TASLAK: önce PATCH, sonra PROMOTE
      const patchUrl = `{% url 'invitations:invitation-detail' 0 %}`.replace("0", editId);
      const patchRes = await fetch(patchUrl, {
        method: "PATCH",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRF() },
        body: JSON.stringify({ ...basePayload, is_draft: true })
      });
      if (!patchRes.ok) throw new Error(await patchRes.text().catch(()=> "PATCH failed"));

      const promoteUrl = `{% url 'invitations:invitation-draft-promote' 0 %}`.replace("0", editId);
      const promoteRes = await fetch(promoteUrl, {
        method: "POST",
        headers: { "X-CSRFToken": getCSRF() }
      });
      const promoteData = (promoteRes.status === 204) ? {} : await promoteRes.json().catch(()=> ({}));
      if (!promoteRes.ok) throw new Error(promoteData?.detail || "Promote failed");

      isEditingDraft = false;
      if (promoteData?.share_url) shareLink.value = promoteData.share_url;

    } else {
      // B) YENİ: tek POST ile yayınlıyoruz
      const createRes = await fetch("{% url 'core:create-invitation-api' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRF() },
        body: JSON.stringify({ ...basePayload, is_draft: false })
      });
      const createData = await createRes.json().catch(()=> ({}));
      if (!createRes.ok) throw new Error(createData?.detail || `HTTP ${createRes.status}`);

      if (createData?.id) {
        editId = String(createData.id);
        isEditing = true;
        isEditingDraft = false;
      }
      if (createData?.share_url || createData?.url || createData?.public_url || createData?.link) {
        shareLink.value = createData.share_url || createData.url || createData.public_url || createData.link;
      }
    }

    showStep(4);
    toast("Davet yayınlandı ✅");
  } catch (err) {
    console.error("Publish error:", err);
    toast("Yayınlanamadı. Lütfen tekrar deneyin.");
  } finally {
    finishBtn.disabled = false; finishBtn.textContent = old;
  }
});


  // ===== Hydrate helper
  function hydrateFromData(data){
    eventTitle.value = data.name || "";
    eventMessage.value = data.message || "";
    if (data.invitation_date){
      const d = new Date(data.invitation_date);
      eventDate.value = d.toISOString().slice(0,10);
      eventTime.value = d.toTimeString().slice(0,5);
    }
    if (typeof data.location === "string") eventLocation.value = data.location;

    const tpl = data.template || "classic";
    document.querySelectorAll(".template-card").forEach(c=>c.classList.remove("selected"));
    document.querySelector(`.template-card[data-template="${tpl}"]`)?.classList.add("selected");
    loadTemplate(tpl);

    protectToggle.checked = !!data.is_password_protected;
    passwordRow.classList.toggle("hidden", !protectToggle.checked);
    invitePassword.value = data.password || "";

    expToggle.checked = !!data.expires_at;
    expiryRow.classList.toggle("hidden", !expToggle.checked);
    expireDate.value = data.expires_at ? data.expires_at.replace("Z","") : "";

    // UI modu
    if (data.is_draft){
      saveDraftBtn?.classList.remove("hidden");
      finishBtn?.classList.remove("hidden");
      updateBtn?.classList.add("hidden");
    } else {
      saveDraftBtn?.classList.add("hidden");
      finishBtn?.classList.add("hidden");
      updateBtn?.classList.remove("hidden");
    }

    // edit flags
    isEditing = true;
    isEditingDraft = !!data.is_draft;
    editId = String(data.id);

    refreshMultiChannel();
  }

  // ===== Init
  shareLink && (shareLink.value = "https://davetjet.com/davet/preview-" + Math.floor(Math.random()*99999));
  showStep(0);
  refreshMultiChannel();

  if (bootMeta) {
    hydrateFromData(bootMeta);
  } else if (editId) {
    loadInvitationById(editId).catch(err => { console.error(err); toast("Kayıt yüklenemedi"); });
  }

  // Reminders bindings (UI)
  remEnabledEl?.addEventListener("change", (e)=>{
    rem.enabled = !!e.target.checked;
    applyRemindersUIEnabled(rem.enabled);
    updateQuotaUI();
  });
  presetEls.forEach(cb=>{
    cb.addEventListener("change", (e)=>{
      if (e.target.checked) rem.presets.add(e.target.value);
      else rem.presets.delete(e.target.value);
      updateQuotaUI();
    });
  });
  customEl?.addEventListener("input", (e)=>{
    const v = parseInt(e.target.value,10);
    rem.customMinutes = Number.isNaN(v) ? null : Math.max(1, v);
    updateQuotaUI();
  });
  channelEls.forEach(cb=>{
    cb.addEventListener("change", (e)=>{
      rem.channels[e.target.value] = !!e.target.checked;
    });
  });
  qhStartEl?.addEventListener("change", (e)=> rem.quietHours.start = e.target.value);
  qhEndEl?.addEventListener("change",  (e)=> rem.quietHours.end   = e.target.value);
  smartRetryEl?.addEventListener("change", (e)=> rem.smartRetry = !!e.target.checked);
});
</script>
{% endblock %}
