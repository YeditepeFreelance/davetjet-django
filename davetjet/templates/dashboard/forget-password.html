{% load static %}

<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Şifremi Unuttum</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
      rel="stylesheet"
    />

    <!-- App CSS & JS -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    <script src="{% static 'scripts/app.js' %}" type="module" defer></script>
    <script src="{% static 'scripts/notifications.js' %}" type="module" defer></script>
    <script src="{% static 'scripts/cooldown.js' %}" type="module" defer></script>
    <script src="{% static 'scripts/timeout.js' %}" type="module" defer></script>
  </head>

  <body class="login-page dark">
    <div class="custom-cursor"></div>

    <div class="blur-circle top-left"></div>
    <div class="blur-circle bottom-right"></div>

    <div class="login-wrapper">
      <div class="login-header">
        <img src="{% static 'images/logo.webp' %}" alt="Logo" />
        <h2>Şifremi Unuttum</h2>
        <p>Hesabınıza ait e-posta adresini girin; sıfırlama bağlantısını gönderelim.</p>
      </div>

      <!-- Django Password Reset form (email alanı) -->
      <form class="login-form" action="{% url 'core:forget-password' %}" method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div class="form-error">
          {% for error in form.non_field_errors %}
            <p>{{ error }}</p>
          {% endfor %}
        </div>
        {% endif %}

        <label>
          <span>E-posta</span>
          <input
            type="email"
            name="email"
            placeholder="ornek@eposta.com"
            required
            value="{{ form.email.value|default_if_none:'' }}"
          />
          {% if form.email.errors %}
          <div class="field-error">
            {% for error in form.email.errors %}
              <p>{{ error }}</p>
            {% endfor %}
          </div>
          {% endif %}
        </label>

        <button type="submit" class="login-btn" id="resetSubmitBtn">Sıfırlama Bağlantısı Gönder</button>
      </form>

      <div class="login-footer">
        <div>
          <p>Parolanızı hatırladınız mı?</p>
          <a href="{% url 'core:login' %}">Giriş Yap</a>
        </div>
        <div>
          <p>Hesabınız yok mu?</p>
          <a href="{% url 'core:register' %}">Kayıt Ol</a>
        </div>
      </div>
    </div>

    <!-- Django messages varsa toast ile göster (opsiyonel) -->
    {% if messages %}
      <script id="dj-messages" type="application/json">
      [
      {% for m in messages %}
        {"level":"{{ m.tags|default:'info' }}","message":"{{ m|escapejs }}"}{% if not forloop.last %},{% endif %}
      {% endfor %}
      ]
      </script>
    {% endif %}

    <!-- Form ve hataları toast’la gösteren minik JS -->
  <script>
// static/scripts/pages/password-reset.js
// XHR + timeout + cooldown + toast dedup

(function () {
  'use strict';
  if (window.__PW_RESET_MOUNTED__) return;
  window.__PW_RESET_MOUNTED__ = true;

  const FORM_SEL = '#passwordResetForm, .login-form';
  const BTN_SEL  = '#resetSubmitBtn';
  const CD_DEFAULT_MS = 60000;      // varsayılan cool-down: 60 sn
  const CD_ON_ERROR_MS = 8000;      // hata sonrası kısa cooldown

  // ---- CSRF
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? decodeURIComponent(m.pop()) : '';
  }
  function getCSRF(form) {
    const inp = form.querySelector('input[name="csrfmiddlewaretoken"]');
    return (inp && inp.value) || getCookie('csrftoken') || '';
  }

  // ---- Django messages / field errors
  function parseMessagesFromDoc(doc) {
    try {
      const tag = doc.getElementById('dj-messages');
      if (!tag) return [];
      const arr = JSON.parse(tag.textContent || '[]');
      return Array.isArray(arr) ? arr : [];
    } catch { return []; }
  }
  function parseFieldErrorsFromText(htmlText) {
    try {
      const doc = new DOMParser().parseFromString(String(htmlText || ''), 'text/html');
      return [...doc.querySelectorAll('.form-error p, .field-error p')]
        .map(p => p.textContent.trim()).filter(Boolean);
    } catch { return []; }
  }

  // ---- XHR POST (status, headers ile birlikte döner)
  function postHTMLWithTimeout(url, bodyParams, csrf, { timeoutMs = 15000 } = {}) {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.responseType = 'text';
      xhr.timeout = timeoutMs;
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
      xhr.setRequestHeader('X-CSRFToken', csrf);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

      xhr.onload = function () {
        const html = xhr.responseText || '';
        const doc  = new DOMParser().parseFromString(html, 'text/html');
        resolve({
          ok: xhr.status >= 200 && xhr.status < 400,
          status: xhr.status,
          doc,
          html,
          getHeader: (n) => xhr.getResponseHeader(n)
        });
      };
      xhr.ontimeout = () => reject(new Error('timeout'));
      xhr.onerror   = () => reject(new Error('network'));
      xhr.send(bodyParams.toString());
    });
  }

  // ---- Küçük toast helper (dedup)
  const seen = new Set();
  function toastOnce(level, msg, opts) {
    if (typeof window.toast !== 'function') return;
    const key = `${level}:${msg}`;
    if (seen.has(key)) return;
    seen.add(key);
    (toast[level] || toast.info)(String(msg||''), Object.assign({ duration: 4500 }, opts||{}));
    setTimeout(() => seen.delete(key), 5000);
  }

  function mount() {
    const form = document.querySelector(FORM_SEL);
    const btn  = document.querySelector(BTN_SEL);
    if (!form || !btn) return;

    let inFlight = false;

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      if (inFlight) return;

      const fd = new FormData(form);
      const email = String(fd.get('email') || '').trim().toLowerCase();
      const cdKey = `pwreset:${email || 'anon'}`;

      // ---- COOLDOWN aktifse blokla + butonda geri sayım göster
      if (window.Cooldown && Cooldown.isCooling(cdKey)) {
        const left = Cooldown.remaining(cdKey);
        toastOnce('warning', `Lütfen bekleyin: ${Math.ceil(left/1000)} sn`);
        Cooldown.bindButtonCountdown(btn, cdKey, { text: 'Sıfırlama Bağlantısı Gönder', whileText: 'Tekrar dene (%s sn)' }).start();
        return;
      }

      // Tek uçuş
      inFlight = true;

      // UI kilitle
      btn.disabled = true;
      const oldTxt = btn.textContent;
      btn.textContent = 'Gönderiliyor…';

      // Yavaş uyarısı
      const slowTimer = setTimeout(() => {
        toastOnce('info', 'Sunucu yanıtı bekleniyor…');
      }, 4000);

      try {
        fd.set('email', email);
        const res = await postHTMLWithTimeout(
          form.action,
          new URLSearchParams(fd),
          getCSRF(form),
          { timeoutMs: 15000 }
        );
        clearTimeout(slowTimer);

        // Mesajları yakala
        const msgs = parseMessagesFromDoc(res.doc);
        if (msgs.length) {
          msgs.forEach(m => {
            const level = (m.level || 'info').toLowerCase();
            toastOnce(level, m.message || '');
          });
          if (msgs.some(m => (m.level || '').toLowerCase() === 'success')) {
            form.reset();
          }
        } else {
          // Fallback: alan hataları
          const errs = parseFieldErrorsFromText(res.html);
          if (errs.length) {
            errs.forEach(msg => toastOnce('error', msg, { duration: 6000 }));
          } else {
            toastOnce('info', 'Eğer bu e-posta kayıtlıysa, sıfırlama bağlantısı gönderildi.');
          }
        }

        // ---- COOLDOWN başlat (Retry-After varsa ona uy)
        if (window.Cooldown) {
          let ms = CD_DEFAULT_MS;
          if (res.status === 429) {
            const ra = Cooldown.parseRetryAfter(res.getHeader('Retry-After'));
            if (ra != null) ms = Math.max(ms, ra);
          }
          Cooldown.set(cdKey, ms);
          Cooldown.bindButtonCountdown(btn, cdKey, { text: oldTxt, whileText: 'Tekrar dene (%s sn)' }).start();
        }

      } catch (err) {
        if (String(err && err.message) === 'timeout') {
          toastOnce('warning', 'İstek zaman aşımına uğradı. Bağlantınızı kontrol edin.');
        } else {
          toastOnce('error', 'Ağ hatası. Lütfen tekrar deneyin.');
        }
        // Hata sonrası kısa cooldown da uygula (spam’i keser)
        if (window.Cooldown) {
          const cdKey = `pwreset:${(form.querySelector('input[name="email"]')?.value || '').toLowerCase() || 'anon'}`;
          Cooldown.set(cdKey, CD_ON_ERROR_MS);
          Cooldown.bindButtonCountdown(btn, cdKey, { text: 'Sıfırlama Bağlantısı Gönder', whileText: 'Tekrar dene (%s sn)' }).start();
        }
      } finally {
        inFlight = false;
        // buton metni, geri sayım yoksa geri dönsün
        if (!window.Cooldown || !Cooldown.isCooling(`pwreset:${email || 'anon'}`)) {
          btn.disabled = false;
          btn.textContent = oldTxt;
        }
      }
    }, { passive: false });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', mount);
  } else {
    mount();
  }
})();

</script>

  </body>
</html>
