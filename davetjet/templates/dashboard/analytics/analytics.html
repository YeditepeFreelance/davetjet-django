{% extends '../dashboard-base.html' %}
{% load static %}

{% block content %}
<div class="analytics">
  <!-- Filters -->
  <section class="analytics__filters glass-card">
    <div class="filters__row">
      <div class="filters__group">
        <label for="invitationSelect">Davet</label>
        <select id="invitationSelect">
          <option value="all">Tümü</option>
          <!-- Backend: dinamik doldur -->
          <option value="1">Ahmet & Ayşe Düğünü</option>
          <option value="2">Ali’nin Doğum Günü</option>
        </select>
      </div>

      <div class="filters__group">
        <label for="channelSelect">Kanal</label>
        <select id="channelSelect">
          <option value="all">Tümü</option>
          <option value="email">E-posta</option>
          <option value="sms">SMS</option>
          <option value="whatsapp">WhatsApp</option>
        </select>
      </div>

      <div class="filters__group">
        <label for="rangeSelect">Tarih Aralığı</label>
        <select id="rangeSelect">
          <option value="7d">Son 7 Gün</option>
          <option value="30d" selected>Son 30 Gün</option>
          <option value="90d">Son 90 Gün</option>
        </select>
      </div>

      <div class="filters__spacer"></div>

      <div class="filters__actions">
        <button id="applyFilters" class="btn btn--primary">Uygula</button>
        <button id="exportCSV" class="btn">CSV Dışa Aktar</button>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="analytics__kpis">
    <div class="kpi glass-card">
      <div class="kpi__label">Toplam Davet</div>
      <div class="kpi__value" id="kpiTotalInvites">–</div>
      <div class="kpi__delta up" id="kpiInvitesDelta">+0%</div>
    </div>
    <div class="kpi glass-card">
      <div class="kpi__label">Teslim</div>
      <div class="kpi__value" id="kpiDelivered">–</div>
      <div class="kpi__sub">Bounce: <span id="kpiBounce">–</span></div>
    </div>
    <div class="kpi glass-card">
      <div class="kpi__label">Açılma Oranı</div>
      <div class="kpi__value" id="kpiOpenRate">–</div>
      <div class="kpi__spark" id="sparklineOpens"></div>
    </div>
    <div class="kpi glass-card">
      <div class="kpi__label">Yanıt Oranı</div>
      <div class="kpi__value" id="kpiRsvpRate">–</div>
      <div class="kpi__sub">Evet: <span id="kpiYesPct">–</span></div>
    </div>
  </section>

  <!-- Charts Row -->
  <section class="analytics__row">
    <!-- RSVP Donut -->
    <div class="panel glass-card">
      <div class="panel__header">
        <h3>RSVP Dağılımı</h3>
        <div class="panel__legend">
          <span class="dot dot--yes"></span>Evet
          <span class="dot dot--maybe"></span>Emin Değil
          <span class="dot dot--no"></span>Hayır
        </div>
      </div>
      <div class="panel__body donut">
        <div class="donut__ring" id="donutRings">
          <!-- CSS conic-gradient ile boyanıyor -->
          <div class="donut__label"><span id="donutCenter">0%</span><small>Yanıt</small></div>
        </div>
        <ul class="donut__list">
          <li><strong id="legendYes">0</strong> Evet</li>
          <li><strong id="legendMaybe">0</strong> Emin Değil</li>
          <li><strong id="legendNo">0</strong> Hayır</li>
        </ul>
      </div>
    </div>

    <!-- Kanal Bazlı Gönderim -->
    <div class="panel glass-card">
      <div class="panel__header">
        <h3>Kanala Göre Gönderimler</h3>
        <div class="panel__legend">
          <span class="dot dot--email"></span>E-posta
          <span class="dot dot--sms"></span>SMS
          <span class="dot dot--wa"></span>WhatsApp
        </div>
      </div>
      <div class="panel__body bars">
        <div class="bars__row">
          <span>E-posta</span>
          <div class="bars__track"><div class="bars__fill email" id="barEmail" style="width:0%"></div></div>
          <strong id="barEmailVal">0</strong>
        </div>
        <div class="bars__row">
          <span>SMS</span>
          <div class="bars__track"><div class="bars__fill sms" id="barSMS" style="width:0%"></div></div>
          <strong id="barSMSVal">0</strong>
        </div>
        <div class="bars__row">
          <span>WhatsApp</span>
          <div class="bars__track"><div class="bars__fill wa" id="barWA" style="width:0%"></div></div>
          <strong id="barWAVal">0</strong>
        </div>
      </div>
    </div>
  </section>

  <!-- Funnel + Timeline -->
  <section class="analytics__row">
    <!-- Funnel -->
    <div class="panel glass-card">
      <div class="panel__header">
        <h3>Davranış Hunisi</h3>
      </div>
      <div class="panel__body funnel">
        <div class="funnel__step" data-label="Gönderildi"><span id="funnelSent">–</span></div>
        <div class="funnel__step" data-label="Açıldı"><span id="funnelOpened">–</span></div>
        <div class="funnel__step" data-label="Tıklandı"><span id="funnelClicked">–</span></div>
        <div class="funnel__step" data-label="Yanıtlandı"><span id="funnelRsvped">–</span></div>
      </div>
    </div>

    <!-- Zaman Serisi (SVG mini chart) -->
    <div class="panel glass-card">
      <div class="panel__header">
        <h3>Günlük Aktiviteler</h3>
      </div>
      <div class="panel__body line">
        <svg id="timelineSVG" viewBox="0 0 300 100" preserveAspectRatio="none" aria-label="Zaman Serisi"></svg>
        <div class="line__legend">
          <span class="dot dot--open"></span>Açılma
          <span class="dot dot--rsvp"></span>RSVP
          <span class="dot dot--send"></span>Gönderim
        </div>
      </div>
    </div>
  </section>

  <!-- Top Invitations Table -->
  <section class="analytics__table glass-card">
    <div class="panel__header">
      <h3>Davetiye Özeti</h3>
      <div class="panel__legend small">En çok etkileşim alan 10 davetiye</div>
    </div>
    <div class="table__wrap">
      <table>
        <thead>
          <tr>
            <th>Davet</th>
            <th>Gönderim</th>
            <th>Açılma</th>
            <th>RSVP</th>
            <th>Son Güncelleme</th>
            <th>Detay</th>
          </tr>
        </thead>
        <tbody id="topInvitesBody">
          <!-- JS dolduracak -->
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ---- Mock / Bağlantı katmanı ------------------------------------------------
// Backend bağlayınca burayı fetch/axios ile değiştir.
// Filtreler baz alınarak örnek veri üretir.
const DataAPI = {
  async getSummary({ invitation='all', channel='all', range='30d' }) {
    // örnek sayılar
    const seed = range === '7d' ? 0.7 : range === '90d' ? 1.3 : 1.0;
    const total = Math.round(820 * seed);
    const delivered = Math.round(total * 0.95);
    const bounces = total - delivered;
    const opened = Math.round(delivered * 0.62);
    const clicked = Math.round(opened * 0.35);
    const rsvped = Math.round(opened * 0.28);
    const yes = Math.round(rsvped * 0.65);
    const maybe = Math.round(rsvped * 0.15);
    const no = Math.max(rsvped - yes - maybe, 0);

    const channels = {
      email: Math.round(delivered * 0.65),
      sms: Math.round(delivered * 0.25),
      whatsapp: Math.max(delivered - Math.round(delivered * 0.9), 0) + Math.round(delivered * 0.10),
    };

    const timelineDays = range === '7d' ? 7 : range === '90d' ? 30 : 14; // grafik sade
    const timeline = Array.from({length: timelineDays}, (_,i) => ({
      send: Math.round((delivered/timelineDays) * (0.7 + Math.random()*0.6)),
      open: Math.round((opened/timelineDays) * (0.7 + Math.random()*0.6)),
      rsvp: Math.round((rsvped/timelineDays) * (0.7 + Math.random()*0.6)),
    }));

    const top = Array.from({length: 10}, (_,i) => ({
      name: `Davet ${i+1}`,
      sent: 40 + Math.round(Math.random()*400),
      opened: 20 + Math.round(Math.random()*300),
      rsvp: 5 + Math.round(Math.random()*150),
      updated: new Date(Date.now() - (i+1)*86400000).toLocaleDateString('tr-TR'),
      url: '#'
    }));

    return {
      totals: { total, delivered, bounces, opened, clicked, rsvped, yes, maybe, no },
      channels,
      timeline,
      top
    };
  }
};

// ---- DOM helpers -------------------------------------------------------------
const $ = (sel, root = document) => root.querySelector(sel);
const setText = (idOrEl, v) => {
  const el = typeof idOrEl === 'string' ? document.getElementById(idOrEl) : idOrEl;
  if (el) el.textContent = v;
};

// ---- Sparkline (mini line) pure SVG -----------------------------------------
function drawSparkline(container, values) {
  const max = Math.max(...values, 1);
  const w = 120, h = 30, pad = 2;
  const pts = values.map((v, i) => {
    const x = pad + (i/(values.length-1))*(w - pad*2);
    const y = h - pad - (v/max)*(h - pad*2);
    return `${x},${y}`;
  }).join(' ');
  container.innerHTML = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" aria-label="mini-chart">
    <polyline fill="none" stroke="currentColor" stroke-width="2" points="${pts}" />
  </svg>`;
}

// ---- Donut (conic-gradient) --------------------------------------------------
function updateDonut({ yes, maybe, no, total }) {
  const donut = document.getElementById('donutRings');
  const sum = Math.max(yes + maybe + no, 1);
  const yesPct = Math.round((yes/sum)*100);
  const maybePct = Math.round((maybe/sum)*100);
  const noPct = 100 - yesPct - maybePct;
  donut.style.setProperty('--donut-yes', `${yesPct}%`);
  donut.style.setProperty('--donut-maybe', `${maybePct}%`);
  donut.style.setProperty('--donut-no', `${noPct}%`);
  setText('donutCenter', `${Math.round((sum/Math.max(total,1))*100)}%`);
  setText('legendYes', yes);
  setText('legendMaybe', maybe);
  setText('legendNo', no);
}

// ---- Bars --------------------------------------------------------------------
function updateBars(channels) {
  const total = Math.max(channels.email + channels.sms + channels.whatsapp, 1);
  const pct = (v) => Math.round((v/total)*100);
  $('#barEmail').style.width = pct(channels.email) + '%';
  $('#barSMS').style.width = pct(channels.sms) + '%';
  $('#barWA').style.width = pct(channels.whatsapp) + '%';
  setText('barEmailVal', channels.email);
  setText('barSMSVal', channels.sms);
  setText('barWAVal', channels.whatsapp);
}

// ---- Funnel ------------------------------------------------------------------
function updateFunnel({ delivered, opened, clicked, rsvped }) {
  setText('funnelSent', delivered);
  setText('funnelOpened', opened);
  setText('funnelClicked', clicked);
  setText('funnelRsvped', rsvped);
}

// ---- Timeline SVG ------------------------------------------------------------
function drawTimeline(data) {
  const svg = document.getElementById('timelineSVG');
  const w = 300, h = 100, pad = 8;
  const max = Math.max(
    ...data.flatMap(d => [d.send, d.open, d.rsvp]),
    1
  );
  const x = (i) => pad + (i/(data.length-1))*(w - pad*2);
  const y = (v) => h - pad - (v/max)*(h - pad*2);

  function poly(values, cls) {
    return `<polyline class="${cls}" fill="none" stroke-width="2" points="${
      values.map((v,i)=>`${x(i)},${y(v)}`).join(' ')
    }" />`;
  }
  svg.innerHTML = `
    <defs>
      <style>
        .line-send{stroke:#9aa0a6}
        .line-open{stroke:#2b8556}
        .line-rsvp{stroke:#1a73e8}
        .grid{stroke:#e9eef3;stroke-width:1}
      </style>
    </defs>
    <!-- grid -->
    <line class="grid" x1="0" y1="${y(max*0.75)}" x2="${w}" y2="${y(max*0.75)}"/>
    <line class="grid" x1="0" y1="${y(max*0.5)}"  x2="${w}" y2="${y(max*0.5)}"/>
    <line class="grid" x1="0" y1="${y(max*0.25)}" x2="${w}" y2="${y(max*0.25)}"/>
    ${poly(data.map(d=>d.send),'line-send')}
    ${poly(data.map(d=>d.open),'line-open')}
    ${poly(data.map(d=>d.rsvp),'line-rsvp')}
  `;
}

// ---- Table -------------------------------------------------------------------
function renderTopInvites(rows) {
  const tbody = document.getElementById('topInvitesBody');
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${r.name}</td>
      <td>${r.sent}</td>
      <td>${r.opened}</td>
      <td>${r.rsvp}</td>
      <td>${r.updated}</td>
      <td><a class="tbl-link" href="${r.url}">Görüntüle</a></td>
    </tr>
  `).join('');
}

// ---- KPI fill ----------------------------------------------------------------
function updateKpis({ total, delivered, bounces, opened, rsvped }) {
  setText('kpiTotalInvites', total);
  setText('kpiDelivered', delivered);
  setText('kpiBounce', bounces);
  const openRate = Math.round((opened/Math.max(delivered,1))*100) + '%';
  setText('kpiOpenRate', openRate);
  const rsvpRate = Math.round((rsvped/Math.max(opened,1))*100) + '%';
  setText('kpiRsvpRate', rsvpRate);
  setText('kpiYesPct', rsvpRate);
  // sparkline
  const spark = document.getElementById('sparklineOpens');
  const pseudo = Array.from({length: 14}, ()=> 5 + Math.round(Math.random()*30));
  drawSparkline(spark, pseudo);
}

// ---- Orkestrasyon ------------------------------------------------------------
async function refresh() {
  const filters = {
    invitation: document.getElementById('invitationSelect').value,
    channel: document.getElementById('channelSelect').value,
    range: document.getElementById('rangeSelect').value
  };
  const data = await DataAPI.getSummary(filters);
  updateKpis(data.totals);
  updateDonut({ yes: data.totals.yes, maybe: data.totals.maybe, no: data.totals.no, total: data.totals.total });
  updateBars(data.channels);
  updateFunnel({
    delivered: data.totals.delivered,
    opened: data.totals.opened,
    clicked: data.totals.clicked,
    rsvped: data.totals.rsvped
  });
  drawTimeline(data.timeline);
  renderTopInvites(data.top);
}

// Events
document.getElementById('applyFilters').addEventListener('click', refresh);
document.getElementById('exportCSV').addEventListener('click', () => exportCSV());

// Basit CSV export
function exportCSV() {
  const rows = [['Davet','Gönderim','Açılma','RSVP','Son Güncelleme']];
  document.querySelectorAll('#topInvitesBody tr').forEach(tr=>{
    const cols = Array.from(tr.children).slice(0,5).map(td=> td.textContent.trim());
    rows.push(cols);
  });
  const csv = rows.map(r=>r.map(v=>`"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'analytics.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// İlk yükleme
refresh();
</script>
{% endblock %}
