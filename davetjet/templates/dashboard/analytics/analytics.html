{% extends '../dashboard-base.html' %}
{% load static %}

{% block content %}
<div class="analytics">
  <!-- Filters -->
  <section class="analytics__filters glass-card">
    <div class="filters__row">
      <div class="filters__group">
        <label for="invitationSelect">Davet</label>
        <select id="invitationSelect">
          <option value="all">Tümü</option>
          <!-- Backend: dinamik doldur -->
          {% for inv in invitations %}
    <option value="{{ inv.pk }}">{{ inv.name }}</option>
    {# veya slug kullanacaksan: value="{{ inv.slug }}" #}
  {% endfor %}
        </select>
      </div>

      <div class="filters__group">
        <label for="channelSelect">Kanal</label>
        <select id="channelSelect">
          <option value="all">Tümü</option>
          <option value="email">E-posta</option>
          <option value="sms">SMS</option>
          <option value="whatsapp">WhatsApp</option>
        </select>
      </div>

      <div class="filters__group">
        <label for="rangeSelect">Tarih Aralığı</label>
        <select id="rangeSelect">
          <option value="7d">Son 7 Gün</option>
          <option value="30d" selected>Son 30 Gün</option>
          <option value="90d">Son 90 Gün</option>
        </select>
      </div>

      <div class="filters__spacer"></div>

      <div class="filters__actions">
        <button id="applyFilters" class="btn btn--primary">Uygula</button>
        <button id="exportCSV" class="btn">CSV Dışa Aktar</button>
      </div>
    </div>
  </section>

  <!-- KPIs -->
  <section class="analytics__kpis">
    <div class="kpi glass-card">
      <div class="kpi__label">Toplam Davet</div>
      <div class="kpi__value" id="kpiTotalInvites">–</div>
      <div class="kpi__delta up" id="kpiInvitesDelta">+0%</div>
    </div>
    <div class="kpi glass-card">
      <div class="kpi__label">Teslim</div>
      <div class="kpi__value" id="kpiDelivered">–</div>
      <div class="kpi__sub">Bounce: <span id="kpiBounce">–</span></div>
    </div>
    <div class="kpi glass-card">
      <div class="kpi__label">Açılma Oranı</div>
      <div class="kpi__value" id="kpiOpenRate">–</div>
      <div class="kpi__spark" id="sparklineOpens"></div>
    </div>
    <div class="kpi glass-card">
      <div class="kpi__label">Yanıt Oranı</div>
      <div class="kpi__value" id="kpiRsvpRate">–</div>
      <div class="kpi__sub">Evet: <span id="kpiYesPct">–</span></div>
    </div>
  </section>

  <!-- Charts Row -->
  <section class="analytics__row">
    <!-- RSVP Donut -->
    <div class="panel glass-card">
      <div class="panel__header">
        <h3>RSVP Dağılımı</h3>
        <div class="panel__legend">
          <span class="dot dot--yes"></span>Evet
          <span class="dot dot--maybe"></span>Emin Değil
          <span class="dot dot--no"></span>Hayır
        </div>
      </div>
      <div class="panel__body donut">
        <div class="donut__ring" id="donutRings">
          <!-- CSS conic-gradient ile boyanıyor -->
          <div class="donut__label"><span id="donutCenter">0%</span><small>Yanıt</small></div>
        </div>
        <ul class="donut__list">
          <li><strong id="legendYes">0</strong> Evet</li>
          <li><strong id="legendMaybe">0</strong> Emin Değil</li>
          <li><strong id="legendNo">0</strong> Hayır</li>
        </ul>
      </div>
    </div>

    <!-- Kanal Bazlı Gönderim -->
    <div class="panel glass-card">
      <div class="panel__header">
        <h3>Kanala Göre Gönderimler</h3>
        <div class="panel__legend">
          <span class="dot dot--email"></span>E-posta
          <span class="dot dot--sms"></span>SMS
          <span class="dot dot--wa"></span>WhatsApp
        </div>
      </div>
      <div class="panel__body bars">
        <div class="bars__row">
          <span>E-posta</span>
          <div class="bars__track"><div class="bars__fill email" id="barEmail" style="width:0%"></div></div>
          <strong id="barEmailVal">0</strong>
        </div>
        <div class="bars__row">
          <span>SMS</span>
          <div class="bars__track"><div class="bars__fill sms" id="barSMS" style="width:0%"></div></div>
          <strong id="barSMSVal">0</strong>
        </div>
        <div class="bars__row">
          <span>WhatsApp</span>
          <div class="bars__track"><div class="bars__fill wa" id="barWA" style="width:0%"></div></div>
          <strong id="barWAVal">0</strong>
        </div>
      </div>
    </div>
  </section>

  <!-- Funnel + Timeline -->
  <section class="analytics__row">
    <!-- Funnel -->
    <div class="panel glass-card">
      <div class="panel__header">
        <h3>Davranış Hunisi</h3>
      </div>
      <div class="panel__body funnel">
        <div class="funnel__step" data-label="Gönderildi"><span id="funnelSent">–</span></div>
        <div class="funnel__step" data-label="Açıldı"><span id="funnelOpened">–</span></div>
        <div class="funnel__step" data-label="Tıklandı"><span id="funnelClicked">–</span></div>
        <div class="funnel__step" data-label="Yanıtlandı"><span id="funnelRsvped">–</span></div>
      </div>
    </div>

    <!-- Zaman Serisi (SVG mini chart) -->
    <div class="panel glass-card">
      <div class="panel__header">
        <h3>Günlük Aktiviteler</h3>
      </div>
      <div class="panel__body line">
        <svg id="timelineSVG" viewBox="0 0 300 100" preserveAspectRatio="none" aria-label="Zaman Serisi"></svg>
        <div class="line__legend">
          <span class="dot dot--open"></span>Açılma
          <span class="dot dot--rsvp"></span>RSVP
          <span class="dot dot--send"></span>Gönderim
        </div>
      </div>
    </div>
  </section>

  <!-- Top Invitations Table -->
  <section class="analytics__table glass-card">
    <div class="panel__header">
      <h3>Davetiye Özeti</h3>
      <div class="panel__legend small">En çok etkileşim alan 10 davetiye</div>
    </div>
    <div class="table__wrap">
      <table>
        <thead>
          <tr>
            <th>Davet</th>
            <th>Gönderim</th>
            <th>Açılma</th>
            <th>RSVP</th>
            <th>Son Güncelleme</th>
            <th>Detay</th>
          </tr>
        </thead>
        <tbody id="topInvitesBody">
          <!-- JS dolduracak -->
        </tbody>
      </table>
    </div>
  </section>

  <section class="analytics__table glass-card" id="recipientsPanel" style="display:none">
  <div class="panel__header">
    <h3>Katılımcı Yanıtları</h3>
    <div class="panel__legend small" style="display:flex; gap:.5rem; align-items:center;">
      <label class="muted">Durum</label>
      <select id="rsvpFilter">
        <option value="all">Tümü</option>
        <option value="yes">Evet</option>
        <option value="maybe">Emin Değil</option>
        <option value="no">Hayır</option>
        <option value="pending">Beklemede</option>
      </select>
      <input id="rsvpSearch" type="search" placeholder="İsim, e-posta, telefon" style="min-width:220px;">
      <button id="rsvpExport" class="btn">CSV</button>
    </div>
  </div>
  <div class="table__wrap">
    <table>
      <thead>
        <tr>
          <th>İsim</th>
          <th>E-posta</th>
          <th>Telefon</th>
          <th>RSVP</th>
          <th>Son Güncelleme</th>
        </tr>
      </thead>
      <tbody id="recipientsBody">
        <!-- JS dolduracak -->
      </tbody>
    </table>
  </div>
</section>

</div>
{% endblock %}

{% block extra_js %}
<script>
// ---- Mock / Bağlantı katmanı ------------------------------------------------
// Backend bağlayınca burayı fetch/axios ile değiştir.
// Filtreler baz alınarak örnek veri üretir.
const DataAPI = {
  // ... mevcut fonksiyonların yanında:
  async getInvitationRecipients(key, { status = 'all', search = '' } = {}) {
    if (!key || key === 'all') return { count: 0, results: [] };
    const base = `/invitations/api/analytics/invitations/${encodeURIComponent(key)}/recipients/`;
    const qs = new URLSearchParams({ status, search });
    const r = await fetch(`${base}?${qs.toString()}`, { headers: { "X-Requested-With":"XMLHttpRequest" }});
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  },


  async listInvitations() {
    const url = "{% url 'invitations:analytics-inv-list' %}";
    const r = await fetch(url, { headers: { "X-Requested-With":"XMLHttpRequest" }});
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  },
  async getSummary({ invitation='all', channel='all', range='30d' }) {
    const base = "{% url 'invitations:analytics-overview' %}";
    const qs = new URLSearchParams({ invitation, channel, range });
    const r = await fetch(`${base}?${qs}`, { headers: { "X-Requested-With":"XMLHttpRequest" }});
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  },
  async getInvitationDetail(id, range='30d') {
    const base = "{% url 'invitations:analytics-inv-detail' pk=0 %}".replace("0", String(id));
    const r = await fetch(`${base}?range=${encodeURIComponent(range)}`, { headers: { "X-Requested-With":"XMLHttpRequest" }});
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }
};
function renderRecipientsTable(rows) {
  const tbody = document.getElementById('recipientsBody');
  if (!tbody) return;
  if (!rows || rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="muted">Kayıt bulunamadı.</td></tr>`;
    return;
  }
  const label = { yes:"Evet", maybe:"Emin Değil", no:"Hayır", pending:"Beklemede" };
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${r.name || "—"}</td>
      <td>${r.email || "—"}</td>
      <td>${r.phone || "—"}</td>
      <td><span class="rsvp-badge rsvp--${r.status}">${label[r.status] || r.status}</span></td>
      <td>${r.updated ? new Date(r.updated).toLocaleString('tr-TR') : "—"}</td>
    </tr>
  `).join('');
}


function exportRecipientsCSV() {
  const rows = [['İsim','E-posta','Telefon','RSVP','Son Güncelleme']];
  document.querySelectorAll('#recipientsBody tr').forEach(tr=>{
    const cols = Array.from(tr.children).map(td=> td.textContent.trim());
    rows.push(cols);
  });
  const csv = rows.map(r=>r.map(v=>`"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'recipients.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// sayfa açılışında dropdown’u doldur
document.addEventListener("DOMContentLoaded", async () => {
  try{
    const sel = document.getElementById('invitationSelect');
    // mevcut “Tümü”’nü koru, altına gerçek liste gelsin
    const list = await DataAPI.listInvitations();
    list.forEach(i => {
      const opt = document.createElement('option');
      opt.value = String(i.id);
      opt.textContent = i.name;
      sel.appendChild(opt);
    });
  }catch(e){ console.warn("Davet listesi alınamadı:", e); }
});
async function refresh() {
  const invitation = document.getElementById('invitationSelect').value;
  const channel    = document.getElementById('channelSelect').value;
  const range      = document.getElementById('rangeSelect').value;
  const panel      = document.getElementById('recipientsPanel');

  // --- panel görünürlüğünü fetch'ten ÖNCE belirle
  if (panel) panel.style.display = (invitation !== "all") ? "" : "none";

  // overview her zaman çekilir
  let data;
  try {
    data = await DataAPI.getSummary({ invitation, channel, range });
    updateKpis(data.totals);
    updateBars(data.channels);
    updateFunnel({
      delivered: data.totals.delivered,
      opened:    data.totals.opened,
      clicked:   data.totals.clicked,
      rsvped:    data.totals.rsvped
    });
    drawTimeline(data.timeline);
    renderTopInvites(data.top);
  } catch (e) {
    console.error("[analytics] overview error:", e);
    // en azından UI çökmeyip eski değerleri korusun
  }

  // tek davet seçildiyse RSVP donut + alıcı listesi
  if (invitation !== "all") {
    try {
      const d = await DataAPI.getInvitationDetail(invitation, range);
      // donut merkez yüzdesi toplam delivered üstünden daha anlamlı
      const totalDelivered = data?.totals?.delivered ?? 1;
      updateDonut({ yes: d.rsvp.yes, maybe: d.rsvp.maybe, no: d.rsvp.no, total: totalDelivered });
    } catch (e) {
      console.warn("[analytics] detail error:", e);
    }

    try {
      const status = document.getElementById('rsvpFilter')?.value || "all";
      const search = document.getElementById('rsvpSearch')?.value?.trim() || "";
      const recs   = await DataAPI.getInvitationRecipients(invitation, { status, search });
      renderRecipientsTable(recs.results);
    } catch (e) {
      console.warn("[analytics] recipients error:", e);
      renderRecipientsTable([]); // boş tablo + "Kayıt bulunamadı" satırı
    }
  }
}


// ---- DOM helpers -------------------------------------------------------------
const $ = (sel, root = document) => root.querySelector(sel);
const setText = (idOrEl, v) => {
  const el = typeof idOrEl === 'string' ? document.getElementById(idOrEl) : idOrEl;
  if (el) el.textContent = v;
};

// ---- Sparkline (mini line) pure SVG -----------------------------------------
function drawSparkline(container, values) {
  const max = Math.max(...values, 1);
  const w = 120, h = 30, pad = 2;
  const pts = values.map((v, i) => {
    const x = pad + (i/(values.length-1))*(w - pad*2);
    const y = h - pad - (v/max)*(h - pad*2);
    return `${x},${y}`;
  }).join(' ');
  container.innerHTML = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" aria-label="mini-chart">
    <polyline fill="none" stroke="currentColor" stroke-width="2" points="${pts}" />
  </svg>`;
}

// ---- Donut (conic-gradient) --------------------------------------------------
function updateDonut({ yes, maybe, no, total }) {
  const donut = document.getElementById('donutRings');
  const sum = Math.max(yes + maybe + no, 1);
  const yesPct = Math.round((yes/sum)*100);
  const maybePct = Math.round((maybe/sum)*100);
  const noPct = 100 - yesPct - maybePct;
  donut.style.setProperty('--donut-yes', `${yesPct}%`);
  donut.style.setProperty('--donut-maybe', `${maybePct}%`);
  donut.style.setProperty('--donut-no', `${noPct}%`);
  setText('donutCenter', `${Math.round((sum/Math.max(total,1))*100)}%`);
  setText('legendYes', yes);
  setText('legendMaybe', maybe);
  setText('legendNo', no);
}

// ---- Bars --------------------------------------------------------------------
function updateBars(channels) {
  const total = Math.max(channels.email + channels.sms + channels.whatsapp, 1);
  const pct = (v) => Math.round((v/total)*100);
  $('#barEmail').style.width = pct(channels.email) + '%';
  $('#barSMS').style.width = pct(channels.sms) + '%';
  $('#barWA').style.width = pct(channels.whatsapp) + '%';
  setText('barEmailVal', channels.email);
  setText('barSMSVal', channels.sms);
  setText('barWAVal', channels.whatsapp);
}

// ---- Funnel ------------------------------------------------------------------
function updateFunnel({ delivered, opened, clicked, rsvped }) {
  setText('funnelSent', delivered);
  setText('funnelOpened', opened);
  setText('funnelClicked', clicked);
  setText('funnelRsvped', rsvped);
}

// ---- Timeline SVG ------------------------------------------------------------
function drawTimeline(data) {
  const svg = document.getElementById('timelineSVG');
  const w = 300, h = 100, pad = 8;
  const max = Math.max(
    ...data.flatMap(d => [d.send, d.open, d.rsvp]),
    1
  );
  const x = (i) => pad + (i/(data.length-1))*(w - pad*2);
  const y = (v) => h - pad - (v/max)*(h - pad*2);

  function poly(values, cls) {
    return `<polyline class="${cls}" fill="none" stroke-width="2" points="${
      values.map((v,i)=>`${x(i)},${y(v)}`).join(' ')
    }" />`;
  }
  svg.innerHTML = `
    <defs>
      <style>
        .line-send{stroke:#9aa0a6}
        .line-open{stroke:#2b8556}
        .line-rsvp{stroke:#1a73e8}
        .grid{stroke:#e9eef3;stroke-width:1}
      </style>
    </defs>
    <!-- grid -->
    <line class="grid" x1="0" y1="${y(max*0.75)}" x2="${w}" y2="${y(max*0.75)}"/>
    <line class="grid" x1="0" y1="${y(max*0.5)}"  x2="${w}" y2="${y(max*0.5)}"/>
    <line class="grid" x1="0" y1="${y(max*0.25)}" x2="${w}" y2="${y(max*0.25)}"/>
    ${poly(data.map(d=>d.send),'line-send')}
    ${poly(data.map(d=>d.open),'line-open')}
    ${poly(data.map(d=>d.rsvp),'line-rsvp')}
  `;
}

// ---- Table -------------------------------------------------------------------
function renderTopInvites(rows) {
  const tbody = document.getElementById('topInvitesBody');
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${r.name}</td>
      <td>${r.sent}</td>
      <td>${r.opened}</td>
      <td>${r.rsvp}</td>
      <td>${r.updated}</td>
      <td><a class="tbl-link" href="${r.url}">Görüntüle</a></td>
    </tr>
  `).join('');
}

// ---- KPI fill ----------------------------------------------------------------
function updateKpis({ total, delivered, bounces, opened, rsvped }) {
  setText('kpiTotalInvites', total);
  setText('kpiDelivered', delivered);
  setText('kpiBounce', bounces);
  const openRate = Math.round((opened/Math.max(delivered,1))*100) + '%';
  setText('kpiOpenRate', openRate);
  const rsvpRate = Math.round((rsvped/Math.max(opened,1))*100) + '%';
  setText('kpiRsvpRate', rsvpRate);
  setText('kpiYesPct', rsvpRate);
  // sparkline
  const spark = document.getElementById('sparklineOpens');
  const pseudo = Array.from({length: 14}, ()=> 5 + Math.round(Math.random()*30));
  drawSparkline(spark, pseudo);
}

// ---- Orkestrasyon ------------------------------------------------------------
{% comment %} async function refresh() {
  const filters = {
    invitation: document.getElementById('invitationSelect').value,
    channel: document.getElementById('channelSelect').value,
    range: document.getElementById('rangeSelect').value
  };
  const data = await DataAPI.getSummary(filters);
  updateKpis(data.totals);
  updateDonut({ yes: data.totals.yes, maybe: data.totals.maybe, no: data.totals.no, total: data.totals.total });
  updateBars(data.channels);
  updateFunnel({
    delivered: data.totals.delivered,
    opened: data.totals.opened,
    clicked: data.totals.clicked,
    rsvped: data.totals.rsvped
  });
  drawTimeline(data.timeline);
  renderTopInvites(data.top);
} {% endcomment %}
// Recipients panel filtreleri
document.getElementById('rsvpFilter')?.addEventListener('change', refresh);
document.getElementById('rsvpSearch')?.addEventListener('input', (e)=>{
  // küçük debounce
  clearTimeout(window.__rsvpSearchT);
  window.__rsvpSearchT = setTimeout(()=> refresh(), 300);
});
document.getElementById('rsvpExport')?.addEventListener('click', exportRecipientsCSV);

// Events
document.getElementById('exportCSV').addEventListener('click', () => exportCSV());
document.getElementById('invitationSelect')?.addEventListener('change', refresh);
document.getElementById('channelSelect')?.addEventListener('change', refresh);
document.getElementById('rangeSelect')?.addEventListener('change', refresh);

// Zaten var: Uygula butonu
document.getElementById('applyFilters')?.addEventListener('click', refresh);

// Basit CSV export
function exportCSV() {
  const rows = [['Davet','Gönderim','Açılma','RSVP','Son Güncelleme']];
  document.querySelectorAll('#topInvitesBody tr').forEach(tr=>{
    const cols = Array.from(tr.children).slice(0,5).map(td=> td.textContent.trim());
    rows.push(cols);
  });
  const csv = rows.map(r=>r.map(v=>`"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'analytics.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// İlk yükleme
refresh();
</script>
{% endblock %}
