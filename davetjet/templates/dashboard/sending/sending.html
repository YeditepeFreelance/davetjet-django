{% extends '../dashboard-base.html' %}
{% load static %}

{% block content %}
<section class="send-page">
  <!-- Üst özet -->
  <header class="send-header glass"
          data-onb="summary"
          data-onb-scope="send"
          data-onb-title="Gönderim Özeti"
          data-onb-desc="Toplam davetli ve kanallara ulaşılabilir kişi sayısını burada görürsünüz."
          data-onb-order="1"
          data-onb-place="bottom">
    <div class="send-header__title">
      <h2>Gönderim Ayarları ({{ invitation.name }})</h2>
      <p class="alt">Davetiyenizi kontrol edin, kanalları seçin ve gönderimi başlatın.</p>
    </div>

    <div class="send-summary">
      <div class="chip">
        <i class="fa-solid fa-users"></i>
        <span>Toplam Davetli</span>
        <strong>{{ statistics.invitee_count|default:"0" }}</strong>
      </div>
      <div class="chip">
        <i class="fa-regular fa-envelope"></i>
        <span>E-posta Ulaşılabilir</span>
        <strong>{{ statistics.email_reachable|default:"0" }}</strong>
      </div>
      <div class="chip">
        <i class="fa-solid fa-mobile-screen"></i>
        <span>SMS Ulaşılabilir</span>
        <strong>{{ statistics.sms_reachable|default:"0" }}</strong>
      </div>
    </div>
  </header>

  <div class="send-layout">
    <!-- Sol kolon: Önizleme + Mesaj -->
    <div class="send-col send-col--main">

      <!-- Mesaj Düzenleyici -->
      <article class="card glass send-card"
               data-onb="message"
               data-onb-scope="send"
               data-onb-title="Mesaj"
               data-onb-desc="Genel mesajınızı yazın. Aşağıda kanal bazlı önizlemelere yansır."
               data-onb-order="2"
               data-onb-place="right">
        <div class="card__head">
          <h3>Mesaj</h3>
          <span class="hint">Bu mesaj, seçtiğiniz kanallara gönderilir. (E-posta/SMS için özelleştirme yapabilirsiniz)</span>
        </div>

        <div class="msg-editor">
          <label class="field">
            <span class="field__label">Genel Mesaj</span>
            <textarea class="field__control" id="general-message" rows="5" placeholder="Davet mesajınız...">{{ invitation.message }}</textarea>
          </label>

          <details class="msg-advanced" open>
            <summary>Gelişmiş (kanal bazlı)</summary>

            <!-- Kanal Önizlemeleri -->
            <article id="channelPreviews" class="card glass send-card channel-previews compact"
                     data-onb="previews"
                     data-onb-scope="send"
                     data-onb-title="Kanal Önizleme"
                     data-onb-desc="E-posta ve SMS içeriklerini burada inceleyin/düzenleyin."
                     data-onb-order="3"
                     data-onb-place="bottom">
              <div class="card__head compact-head">
                <h3>Önizleme</h3>
                <div class="preview-tabs" role="tablist" aria-label="Kanal Önizleme">
                  <button type="button" class="tab active" data-tab="email" role="tab" aria-selected="true">
                    <i class="fa-regular fa-envelope"></i> E-posta
                  </button>
                  <button type="button" class="tab" data-tab="sms" role="tab" aria-selected="false">
                    <i class="fa-solid fa-mobile-screen"></i> SMS
                  </button>
                </div>
              </div>

              <div class="panels">
                <!-- E-posta paneli -->
                <section class="preview-panel panel-email" data-panel="email" role="tabpanel">
                  <div class="mini-head">
                    <div class="from">
                      <div class="avatar">DJ</div>
                      <div class="meta">
                        <strong>Davetiye • DavetJet</strong>
                        <small>&lt;noreply@davetjet.com&gt;</small>
                      </div>
                    </div>
                    <div class="to"><small>Kime:</small> <span class="chip">alici@example.com</span></div>
                  </div>

                  <div class="row subject">
                    <label for="mail-subject-input">Konu</label>
                    <input id="mail-subject-input" type="text" class="mini-input" value="Davetiyeniz">
                  </div>

                  <div id="mail-body-preview" class="ed ed-mail" contenteditable="true" spellcheck="false" dir="ltr"></div>

                  <div class="row cta">
                    <a id="mail-link-preview" class="btn btn--primary btn-mini" href="#" target="_blank" rel="noopener">Davetiye Linki</a>
                    <small class="muted url" id="mail-link-text"></small>
                  </div>
                </section>

                <!-- SMS paneli (varsayılan gizli; turu bu panele bağlamadık) -->
                <section class="preview-panel panel-sms hidden" data-panel="sms" role="tabpanel" hidden>
                  <div class="sms-compact">
                    <div id="sms-body-preview" class="bubble" contenteditable="true" spellcheck="false" dir="ltr"></div>
                    <div class="sms-meta"><small id="sms-counter">0 karakter • 0/1 SMS</small></div>
                  </div>
                </section>
              </div>
            </article>
          </details>
        </div>
      </article>
    </div>

    <!-- Sağ kolon: Kanallar + Zamanlama + Onay -->
    <aside class="send-col send-col--side">
      <!-- Kanallar -->
      <section class="card glass send-card"
               data-onb="channels"
               data-onb-scope="send"
               data-onb-title="Kanallar"
               data-onb-desc="Göndermek istediğiniz kanalları açın/kapatın."
               data-onb-order="4"
               data-onb-place="left">
        <div class="card__head">
          <h3>Kanallar</h3>
          <span class="hint">Kullanmak istediğiniz kanalları seçin.</span>
        </div>

        <div class="channel-list">
          <label class="toggle">
            <input type="checkbox" name="channel_email" checked>
            <span class="toggle__ui">
              <i class="fa-regular fa-envelope"></i>
              <span>E-posta</span>
            </span>
            <span class="meta">{{ statistics.email_reachable|default:"0" }} kişi</span>
          </label>

          <label class="toggle">
            <input type="checkbox" name="channel_sms" {% if statistics.sms_reachable > 0 %}checked{% endif %}>
            <span class="toggle__ui">
              <i class="fa-solid fa-mobile-screen"></i>
              <span>SMS</span>
            </span>
            <span class="meta">{{ statistics.sms_reachable|default:"0" }} kişi</span>
          </label>

          <label class="toggle disabled">
            <input type="checkbox" name="channel_whatsapp" disabled>
            <span class="toggle__ui">
              <i class="fa-brands fa-whatsapp"></i>
              <span>WhatsApp</span>
            </span>
            <span class="meta">Yakında</span>
          </label>
        </div>
      </section>

      <!-- Zamanlama -->
      <section class="card glass send-card"
               data-onb="schedule"
               data-onb-scope="send"
               data-onb-title="Zamanlama"
               data-onb-desc="Hemen gönderin ya da belirli tarih/saat için planlayın."
               data-onb-order="5"
               data-onb-place="left">
        <div class="card__head">
          <h3>Zamanlama</h3>
        </div>

        <div class="schedule">
          <label class="radio">
            <input type="radio" name="schedule_mode" value="now" checked>
            <span>Hemen gönder</span>
          </label>

          <label class="radio">
            <input type="radio" name="schedule_mode" value="later">
            <span>Belirli tarihte gönder</span>
          </label>

          <div class="schedule__row">
            <label class="field">
              <span class="field__label">Tarih</span>
              <input class="field__control" type="date" name="send_date" />
            </label>
            <label class="field">
              <span class="field__label">Saat</span>
              <input class="field__control" type="time" name="send_time" />
            </label>
          </div>

          <small class="hint">Planlı gönderim seçerseniz davet mesajınız belirtilen tarih/saatte iletilir.</small>
        </div>
      </section>

      <!-- Özet & Onay -->
      <section class="card glass send-card"
               data-onb="review"
               data-onb-scope="send"
               data-onb-title="Gönderim Özeti"
               data-onb-desc="Seçili kanallar ve alıcı sayılarını kontrol edin."
               data-onb-order="6"
               data-onb-place="left">
        <div class="card__head">
          <h3>Gönderim Özeti</h3>
        </div>

        <ul class="summary-list">
          <li><span>Toplam davetli</span><strong>{{ statistics.invitee_count|default:"0" }}</strong></li>
          <li><span>E-posta gidecek</span><strong>{{ statistics.email_reachable|default:"0" }}</strong></li>
          <li><span>SMS gidecek</span><strong>{{ statistics.sms_reachable|default:"0" }}</strong></li>
        </ul>

        <label class="agree"
               data-onb="confirm"
               data-onb-scope="send"
               data-onb-title="Onay"
               data-onb-desc="Gönderimi başlatmadan önce bu onayı işaretleyin."
               data-onb-order="7"
               data-onb-place="top">
          <input type="checkbox" name="confirm_all" />
          <span>Davetiye ve davetlileri onaylıyorum</span>
        </label>

        <div class="actions"
             data-onb="send-start"
             data-onb-scope="send"
             data-onb-title="Gönderimi Başlat"
             data-onb-desc="Onayladıktan sonra gönderimi başlatabilirsiniz."
             data-onb-order="8"
             data-onb-place="top">
          <a href="{% url 'core:edit-recipients' invitation.pk %}" class="btn btn--outlined send-btn">Davetli Listesi</a>
          <button type="button" class="btn btn--primary send-btn">Gönderime Başla</button>
        </div>
      </section>
    </aside>
  </div>
</section>
{% endblock %}

{% block body-page %}sending{% endblock %}

{% block extra_js %}
<style>
  /* Kritik minimum: sekmeler için görünürlük */
  .preview-panel.hidden{ display:none; }
</style>

<script>
(function(){
  // ---------- Helpers ----------
  const qs  = (s, r=document)=>r.querySelector(s);
  const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));

  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? decodeURIComponent(m.pop()) : null;
  }
  function flash(type, text){
    const host = document.querySelector('.send-header') || document.body;
    const box = document.createElement('div');
    box.className = 'send-flash ' + type;
    box.textContent = text;
    box.style.cssText = "margin-top:12px;padding:10px 12px;border-radius:10px;font-weight:600;"
      + (type==='success'
         ? "background:#e7f7ef;color:#1f6f46;border:1px solid #c8efd9;"
         : "background:#fdecea;color:#8a1f17;border:1px solid #f5c6c3;");
    host.appendChild(box); setTimeout(()=> box.remove(), 5000);
  }
  function combineLocalToISO(dateStr, timeStr){
    if(!dateStr || !timeStr) return null;
    const [y,m,d] = dateStr.split('-').map(Number);
    const [hh,mm] = timeStr.split(':').map(Number);
    const dt = new Date(y, (m-1), d, hh, mm, 0);
    return dt.toISOString();
  }
  function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
  function nl2br(txt){ return escapeHTML(txt).replace(/\n/g,'<br>'); }
  function smsPartsInfo(txt){
    const isAscii = /^[\x00-\x7F]*$/.test(txt || "");
    const per = isAscii ? 160 : 70;
    const concat = isAscii ? 153 : 67;
    const len = (txt||"").length;
    const parts = len <= per ? (len?1:0) : Math.ceil(len/concat);
    const inPart = len <= per ? len : (len % concat || concat);
    const limit = len <= per ? per : concat;
    return {len, parts, inPart, limit};
  }

  document.addEventListener('DOMContentLoaded', function(){
    const root = qs('.send-page'); if(!root) return;

    // ---------- Context ----------
    const INV_ID   = {{ invitation.id }};
    const INV_SLUG = "{{ invitation.slug }}";
    const INV_TITLE= "{{ invitation.name|escapejs }}";
    const INV_DATE = "{{ invitation.invitation_date|date:'d.m.Y' }}";
    const INV_TIME = "{{ invitation.invitation_date|time:'H:i' }}";
    const INV_LOC  = "{{ invitation.location|default_if_none:''|escapejs }}";
    const PRETTY_URL = `${location.origin}/invitations/${INV_SLUG}/`;
    const API_SEND_URL = `/invitations/api/schedule-send/${INV_ID}/`;

    // ---------- Controls ----------
    const emailTgl = qs('input[name="channel_email"]', root);
    const smsTgl   = qs('input[name="channel_sms"]', root);
    const agree    = qs('input[name="confirm_all"]', root);
    const btnPlan  = qs('.actions .btn.btn--primary', root);

    const scheduleRadios = qsa('input[name="schedule_mode"]', root);
    const dateInput = qs('input[name="send_date"]', root);
    const timeInput = qs('input[name="send_time"]', root);

    const generalTextarea = qs('#general-message', root);

    // ---------- Preview elements ----------
    const previewRoot     = qs('#channelPreviews', root);
    const tabButtons      = qsa('.preview-tabs .tab', previewRoot);
    const emailPanel      = qs('.panel-email', previewRoot);
    const smsPanel        = qs('.panel-sms', previewRoot);

    const mailSubjectInput= qs('#mail-subject-input', previewRoot);
    const mailBodyEl      = qs('#mail-body-preview', previewRoot);
    const mailLinkEl      = qs('#mail-link-preview', previewRoot);
    const mailLinkText    = qs('#mail-link-text', previewRoot);

    const smsBodyEl       = qs('#sms-body-preview', previewRoot);
    const smsCounterEl    = qs('#sms-counter', previewRoot);

    // ---------- Defaults ----------
    function buildDefaults(){
      const when  = [INV_DATE, INV_TIME].filter(Boolean).join(" • ");
      const where = INV_LOC ? `, ${INV_LOC}` : "";
      const base  = `${INV_TITLE} davetine ${when}${where} bekleriz.`;
      const tail  = `Detaylar/Katılım: ${PRETTY_URL}`;
      const general = `${base}\n${tail}`;
      const emailSubject = `${INV_TITLE} — Davetiye`;
      const email = `Merhaba,\n\n${base}\n\n${tail}\n\nSevgiler,`;
      const sms   = `${INV_TITLE} davetine bekleriz. ${when}${where}\n${PRETTY_URL}`;
      return { general, emailSubject, email, sms };
    }
    const defaults = buildDefaults();

    // Genel alan boşsa doldur
    if (generalTextarea && !generalTextarea.value.trim()) generalTextarea.value = defaults.general;
    if (mailSubjectInput) mailSubjectInput.value = defaults.emailSubject;

    // Dirty flags: kullanıcı panel içinden düzenlediyse genel mesaj değişince üzerine yazmayalım
    let emailDirty = false;
    let smsDirty   = false;

    // ---------- Renderers ----------
    function renderMail(){
      const fallback = (generalTextarea?.value || defaults.email).trim();
      const content  = emailDirty ? mailBodyEl.innerText : fallback;
      mailBodyEl.innerHTML = nl2br(content || defaults.email);
      mailLinkEl.href = PRETTY_URL;
      mailLinkText.textContent = PRETTY_URL;
    }
    function renderSMS(){
      const fallback = (generalTextarea?.value || defaults.sms).trim();
      const content  = smsDirty ? smsBodyEl.innerText : fallback;
      smsBodyEl.textContent = content || defaults.sms;
      const meta = smsPartsInfo(smsBodyEl.textContent);
      smsCounterEl.textContent = `${meta.len} karakter • ${meta.inPart}/${meta.parts||1} SMS`;
    }

    // İlk render
    renderMail(); renderSMS();

    // Genel mesaj değişirse, paneli dirty değilse senkronize et
    generalTextarea?.addEventListener('input', ()=>{
      if(!emailDirty) renderMail();
      if(!smsDirty)   renderSMS();
    });

    // Panel içi düzenlemeler dirty yapsın
    mailBodyEl?.addEventListener('input', ()=>{ emailDirty = true; });
    smsBodyEl ?.addEventListener('input', ()=>{ smsDirty   = true; renderSMS(); });

    // ---------- Tabs ----------
    function showTab(tab){
      const isEmail = (tab === 'email');
      emailPanel.classList.toggle('hidden', !isEmail);
      smsPanel  .classList.toggle('hidden',  isEmail);
      emailPanel.toggleAttribute('hidden', !isEmail);
      smsPanel  .toggleAttribute('hidden',  isEmail);
      tabButtons.forEach(b=>{
        const active = (b.dataset.tab === tab);
        b.classList.toggle('active', active);
        b.setAttribute('aria-selected', active ? 'true' : 'false');
      });
    }
    tabButtons.forEach(btn=>{
      btn.addEventListener('click', (e)=>{ e.preventDefault(); showTab(btn.dataset.tab); });
    });
    showTab('email');

    // ---------- Kanal aç/kapa -> panel durumu ----------
    function syncChannelPanels(){
      const eOn = !!emailTgl?.checked;
      const sOn = !!smsTgl?.checked;
      emailPanel.classList.toggle('is-off', !eOn);
      smsPanel  .classList.toggle('is-off', !sOn);
      mailBodyEl.setAttribute('contenteditable', eOn ? 'true' : 'false');
      smsBodyEl .setAttribute('contenteditable', sOn ? 'true' : 'false');
    }
    emailTgl?.addEventListener('change', syncChannelPanels);
    smsTgl  ?.addEventListener('change',  syncChannelPanels);
    syncChannelPanels();

    // ---------- Zamanlama ----------
    function syncScheduleInputs(){
      const mode = qs('input[name="schedule_mode"]:checked', root)?.value || 'now';
      const dis = (mode!=='later');
      dateInput.disabled = dis; timeInput.disabled = dis;
      dateInput.parentElement.style.opacity = dis ? .6 : 1;
      timeInput.parentElement.style.opacity = dis ? .6 : 1;
    }
    scheduleRadios.forEach(r=>r.addEventListener('change', syncScheduleInputs));
    syncScheduleInputs();

    // ---------- Gönder/Planla ----------
    async function handleSubmit(){
      const channels = { email: !!emailTgl?.checked, sms: !!smsTgl?.checked };
      if(!channels.email && !channels.sms){ return toast.error('En az bir kanal seçmelisiniz (E-posta veya SMS).'); }
      if(!agree?.checked){ return toast.error('“Davetiye ve davetlileri onaylıyorum” kutusunu işaretleyin.'); }

      const mode = qs('input[name="schedule_mode"]:checked', root)?.value || 'now';
      let scheduled_at = null;
      if(mode==='later'){
        if(!dateInput.value || !timeInput.value){ return toast.error('Planlı gönderim için tarih ve saat seçin.'); }
        scheduled_at = combineLocalToISO(dateInput.value, timeInput.value);
      }

      // Gönderilecek metinleri **doğrudan önizleme** alanlarından oku
      const email_message = (mailBodyEl.innerText || '').trim() || (generalTextarea?.value || '').trim() || defaults.email;
      const sms_message   = (smsBodyEl.innerText  || '').trim() || (generalTextarea?.value || '').trim() || defaults.sms;

      const payload = {
        invitation_id: {{ invitation.id }},
        slug: "{{ invitation.slug }}",
        channels,
        message: (generalTextarea?.value || '').trim(),
        email_message: channels.email ? email_message : null,
        sms_message:   channels.sms   ? sms_message   : null,
        // İstersen backend destekliyorsa:
        // email_subject: (mailSubjectInput?.value || 'Davetiyeniz').trim(),
        schedule: { mode, scheduled_at }
      };

      try{
        btnPlan.disabled = true; btnPlan.textContent = 'Gönderim ayarlanıyor…';
        const res = await fetch(API_SEND_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken': getCookie('csrftoken') || ''},
          credentials:'same-origin',
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=> ({}));
        if(res.ok){ toast.success(data.message || 'Gönderim planlandı!'); }
        else      { toast.error(data.error || 'Gönderim sırasında hata oluştu.'); }
      }catch(e){
        toast.error('Ağ hatası. Lütfen tekrar deneyin.');
      }finally{
        btnPlan.disabled = false; btnPlan.textContent = 'Onayla ve Planla';
      }
    }
    btnPlan?.addEventListener('click', handleSubmit);
  });
})();
</script>
{% endblock %}
