{% extends '../dashboard-base.html' %} {% load static %} {% block content %}
<section class="overview scrollable">
    <div class="overview-top">
    <div>
      <h1>Liste: {{ project.name }}</h1>
      <p>
        Bu ekrandan davetiye listenize göz atabilir ve düzenleyebilirsiniz.
      </p>
    </div>
    <a href="#" class="btn btn--create" id="back-to-lists">
      <i class="fa-solid fa-chevron-left"></i>
    </a>
  </div>

  <!-- Bottom Section -->
  <div class="bottom-widgets">
    <div class="card invite-preview" style="grid-column: 1 / -1">
      <h3>Hızlı İşlemler</h3>
      <div class="content">
        <img src="{% static 'images/invitation-sample.png' %}" alt="Davetiye" />
        <div class="actions">
          <a
            data-target="{% url 'recipients:export-csv' %}?project_id={{ project.id }}"
            class="export-csv"
            >CSV Dışa Aktar</a
          >
          <a data-target="{% url 'recipients:import-csv' %}" class="import-csv"
            >İçe Aktar</a
          >
          <a data-target="{% url 'recipients:add_new' %}" class="add-manually">Manuel Olarak Ekle</a>
        </div>
      </div>
    </div>
    <div class="card recipient-tracking"  style="grid-column: 1 / -1">
      <h3>Davetli Takibi</h3>
      <div class="content">
        <table>
          <thead>
            <tr>
              <th>Ad</th>
              <th>Email</th>
              <th>Telefon</th>
              <th>Durum</th>
              <th>İşlem</th>
            </tr>
          </thead>
          <tbody>
            {% for recipient in project.recipients.all %}
            <tr data-id="recipient-{{ recipient.id }}">
              <td>{{ recipient.name }}</td>
              <td>{{ recipient.email }}</td>
              <td>{{ recipient.phone_number }}</td>
              <td>{{ recipient.rsvp }}</td>
              <td class="actions">
                <a href="#" class="edit-recipient">Düzenle</a>
                <a class="delete-recipient">Sil</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5">Henüz davetli eklenmemiş.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>
{% endblock %} 
 
{% block extra_js %}
{% if recipient_quota_json %}
  <script>window.RECIPIENT_QUOTA = {{ recipient_quota_json|safe }};</script>
{% endif %}

<script>
(function(){
  // ------- UTILS
  const getCSRF = () => (document.cookie.match(/csrftoken=([^;]+)/)?.[1] ?? "");
  const qs = (sel, root=document) => root.querySelector(sel);
  const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const toast = (msg) => { try{ window.AppModal?.open?.("alert",{title:"Bilgi",body:`<p>${msg}</p>`}); }catch{ alert(msg); } };

  // ------- ELEMENTS
  const backToListsBtn = qs("#back-to-lists");
  const addManuallyBtn = qs(".add-manually");
  const importCSVBtn = qs(".import-csv");
  const exportCSVBtn = qs(".export-csv");
  const deleteRecipientBtns = qsa(".delete-recipient");
  const editRecipientBtns = qsa(".edit-recipient");

  // ------- QUOTA STATE
  const quota = { limit: 0, used: 0, remaining: 0, loaded: false };

  // UI: quota pill (üst başlığa iliştiriyoruz)
  function ensureQuotaPill(){
    let host = qs(".overview-top > div"); if(!host) return;
    if(!qs(".quota-pill", host)){
      const div = document.createElement("div");
      div.className = "quota-pill";
      div.style.cssText = "margin-top:8px;font-size:16px;opacity:.9; color: #333;";
      div.innerHTML = `<span id="quotaText">Davetli hakkı yükleniyor…</span>`;
      host.appendChild(div);
    }
  }
  function renderQuota(){
    ensureQuotaPill();
    const el = qs("#quotaText");
    if(!el) return;
    el.textContent = `Davetli Hakkı: ${quota.used}/${quota.limit} • Kalan: ${quota.remaining}`;
    // Butonları koşula göre kilitle
    const lock = quota.remaining <= 0;
    [addManuallyBtn, importCSVBtn].forEach(btn => {
      if(!btn) return;
      btn.classList.toggle("is-disabled", lock);
      if(lock){ btn.setAttribute("aria-disabled","true"); btn.style.pointerEvents="auto"; btn.style.opacity=".6"; btn.title="Davetli hakkınız kalmadı"; }
      else { btn.removeAttribute("aria-disabled"); btn.style.opacity=""; btn.title=""; }
    });
  }

  // Backend’ten kota çek (1) window.RECIPIENT_QUOTA varsa kullan, (2) API dene, (3) DOM fallback
  async function fetchRecipientQuota(){
    // 1) window’dan al
    if(window.RECIPIENT_QUOTA && typeof window.RECIPIENT_QUOTA.limit === "number"){
      Object.assign(quota, {
        limit: Number(window.RECIPIENT_QUOTA.limit)||0,
        used: Number(window.RECIPIENT_QUOTA.used)||0
      });
      quota.remaining = Math.max(0, quota.limit - quota.used);
      quota.loaded = true; renderQuota(); return;
    }
    // 2) API dene
    try{
      const url = `/recipients/api/quota/?project_id={{ project.id }}`;
      const r = await fetch(url, { headers: { "X-Requested-With":"XMLHttpRequest" }});
      if(r.ok){
        const data = await r.json();
        if(typeof data.limit === "number"){
          quota.limit = Number(data.limit)||0;
          quota.used  = Number(data.used)||0;
          quota.remaining = Math.max(0, quota.limit - quota.used);
          quota.loaded = true; renderQuota(); return;
        }
      }
    }catch(e){ /* yoksay */ }
    // 3) Fallback: DOM’daki mevcut satır sayısı
    const rows = qsa('tbody tr[data-id^="recipient-"]');
    quota.used = rows.length;
    quota.limit = Math.max(quota.used, 1);   // engelleme yapmamak için minimum eşitlik
    quota.remaining = Math.max(0, quota.limit - quota.used);
    quota.loaded = true; renderQuota();
  }

  // ------- NAV
  backToListsBtn?.addEventListener("click", (e)=>{ e.preventDefault(); window.location.href = "{% url 'core:recipients' %}"; });

  // ------- ADD (manuel) — kota kontrol
  addManuallyBtn?.addEventListener("click", function (event) {
    event.preventDefault();
    if(quota.loaded && quota.remaining <= 0){ toast("Davetli hakkınız kalmadı."); return; }

    window.AppModal.open("form", {
      title: "Davetli Ekle",
      body: `
        <form id="add-recipient-form" method="POST">
          <input type="hidden" name="csrfmiddlewaretoken" value="${getCSRF()}">
          <label for="recipient-name">Ad:</label>
          <input type="text" id="recipient-name" name="name" style="color: white;" required />
          <label for="recipient-email">Email:</label>
          <input type="email" id="recipient-email" name="email" style="color: white;" required />
          <label for="recipient-phone">Telefon:</label>
          <input type="text" id="recipient-phone" name="phone_number" style="color: white;" required />
        </form>
      `,
      footer: `
        <div class="modal__buttons">
          <button class="btn btn--cancel modal-exit" onclick="window.AppModal.close()">İptal</button>
          <button class="btn btn--primary" id="save-recipient">Kaydet</button>
        </div>
      `,
    });

    qs("#save-recipient")?.addEventListener("click", function () {
      const form = qs("#add-recipient-form");
      const formData = new FormData(form);
      formData.append("project_id", "{{ project.id }}");

      fetch("{% url 'recipients:add_new' %}", {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": getCSRF() },
      })
      .then((response) => {
        if (!response.ok) return response.text().then((t)=>{ throw new Error(t); });
        return response.text();
      })
      .then(() => {
        // anında sayaç güncelle (sayfa yenilenmeden)
        quota.used += 1; quota.remaining = Math.max(0, quota.limit - quota.used);
        renderQuota();
        window.AppModal.close();
        location.reload();
      })
      .catch((error) => { toast("Davetli ekleme başarısız: " + error.message); });
    });
  });

  // ------- DELETE — kota iade
  deleteRecipientBtns.forEach((btn) => {
    btn.addEventListener("click", function (event) {
      event.preventDefault();
      const row = this.closest("tr");
      const recipientId = row.getAttribute("data-id");        // "recipient-123"
      const recipientName = row.querySelector("td:first-child").textContent;

      window.AppModal.open("confirm", {
        title: "Davetli Sil",
        body: `<p><strong>${recipientName}</strong> adlı davetliyi silmek istediğinize emin misiniz?</p>`,
        footer: `
          <div class="modal__buttons">
            <button class="btn btn--cancel modal-exit" onclick="window.AppModal.close()">İptal</button>
            <button class="btn btn--danger" id="confirm-delete" data-id="${recipientId}">Sil</button>
          </div>
        `,
      });

      setTimeout(() => {
        const confirmBtn = qs("#confirm-delete");
        confirmBtn?.addEventListener("click", function () {
          const idToDelete = this.getAttribute("data-id");
          fetch("/recipients/delete/" + idToDelete.split('-')[1], {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          })
          .then((response) => {
            if (!response.ok) return response.text().then((t)=>{ throw new Error(t); });
            return response.text();
          })
          .then(() => {
            row.remove();
            // sayaç güncelle
            quota.used = Math.max(0, quota.used - 1);
            quota.remaining = Math.max(0, quota.limit - quota.used);
            renderQuota();
            window.AppModal.close();
          })
          .catch((error) => { toast("Silme işlemi başarısız: " + error.message); });
        });
      }, 10);
    });
  });

  // ------- EDIT (değişmedi)
  editRecipientBtns.forEach((btn) => {
    btn.addEventListener("click", function (event) {
      event.preventDefault();
      const row = this.closest("tr");
      const recipientName = row.querySelector("td:first-child").textContent;
      const recipientEmail = row.querySelector("td:nth-child(2)").textContent;

      window.AppModal.open("form", {
        title: "Davetli Düzenle",
        body: `
          <form id="edit-recipient-form" data-id="${row.dataset.id}" method="POST">
            <input type="hidden" name="csrfmiddlewaretoken" value="${getCSRF()}">
            <label for="recipient-name">Ad:</label>
            <input type="text" id="recipient-name" value="${recipientName}" required />
            <label for="recipient-email">Email:</label>
            <input type="email" id="recipient-email" value="${recipientEmail}" required />
          </form>
        `,
        footer: `
          <div class="modal__buttons">
            <button class="btn btn--cancel modal-exit" id="modal-close" onclick="window.AppModal.close()">İptal</button>
            <button class="btn btn--success" data-id="${row.dataset.id}" id="save-changes">Kaydet</button>
          </div>
        `,
      });

      qsa("#save-changes").forEach(button => {
        button.addEventListener("click", function () {
          const recipientId = this.getAttribute("data-id");
          const formRec = qs(`form[data-id="${recipientId}"]`);
          if (!formRec) return toast("Form bulunamadı.");

          const nameInput = formRec.querySelector("#recipient-name");
          const emailInput = formRec.querySelector("#recipient-email");
          const csrfToken = getCSRF();

          if (!nameInput.value.trim() || !emailInput.value.trim()) return toast("Lütfen tüm alanları doldurun.");

          const formData = new FormData();
          formData.append("recipient_id", recipientId.split("-")[1]);
          formData.append("name", nameInput.value);
          formData.append("email", emailInput.value);
          formData.append("csrfmiddlewaretoken", csrfToken);

          fetch("{% url 'recipients:edit' %}", { method: "POST", body: formData })
          .then(response => { if (!response.ok) return response.text().then(t=>{ throw new Error(t); }); return response.text(); })
          .then(() => {
            const row = qs(`tr[data-id="${recipientId}"]`);
            if (row) {
              row.querySelector("td:first-child").textContent = nameInput.value;
              row.querySelector("td:nth-child(2)").textContent = emailInput.value;
            }
            window.AppModal?.close?.();
          })
          .catch(error => { console.log(error); toast("Güncelleme başarısız: " + error.message); });
        });
      });
    });
  });

  // ------- EXPORT (değişmedi)
  exportCSVBtn?.addEventListener("click", function (event) {
    event.preventDefault();
    const url = exportCSVBtn.getAttribute("data-target");
    let id = new URLSearchParams(url.split("?")[1]).get("project_id");
    fetch(url)
      .then((response) => response.blob())
      .then((blob) => {
        const link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);
        link.download = `recipients_${id}_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
      })
      .catch((error) => console.error("CSV export failed:", error));
  });

  // ------- IMPORT — kota kontrol
  importCSVBtn?.addEventListener("click", function (event) {
    event.preventDefault();
    if(quota.loaded && quota.remaining <= 0){ toast("Davetli hakkınız kalmadı."); return; }

    const url = importCSVBtn.getAttribute("data-target");
    const fileInput = document.createElement("input");
    fileInput.type = "file"; fileInput.accept = ".csv";
    fileInput.onchange = function () {
      const file = fileInput.files[0];
      if (file) {
        // Bilgilendir: kalan hak kadar kişi işlenir (sunucu tarafında da doğrulayın)
        toast(`Yükleme başlıyor. Kalan hakkınız: ${quota.remaining}. Fazlası işlenmeyecektir.`);
        const formData = new FormData();
        formData.append("file", file);
        formData.append("project_id", "{{ project.id }}");

        fetch(url, { method: "POST", body: formData, headers: { "X-CSRFToken": getCSRF() } })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // backend kaç kişi eklendi bilgisini dönerse burada sayaç güncellenebilir
              if (typeof data.added === "number") {
                quota.used = Math.min(quota.limit, quota.used + data.added);
                quota.remaining = Math.max(0, quota.limit - quota.used);
                renderQuota();
              }
              alert("CSV dosyası başarıyla yüklendi.");
              location.reload();
            } else {
              alert("Hata: " + (data.error || "Bilinmeyen hata"));
            }
          })
          .catch((error) => console.error("CSV import failed:", error));
      }
    };
    fileInput.click();
  });

  // İlk yüklemede kota çek & göster
  ensureQuotaPill();
  fetchRecipientQuota();
})();
</script>
{% endblock %}
